---
title: "gmd_data_analysis"
author: "Heike Sprenger"
date: "July 14, 2015"
output: 
  html_document:
    toc: true
    theme: cerulean
    number_section: true
    highlight: tango
---

## Set pander and knitr options
```{r set pander and knitr options, message=FALSE}
library(knitr)
library(pander)

# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width=5, fig.height=5, cache=FALSE, highlight = TRUE, fig.show="asis")
#opts_knit$set(root.dir = '../')
```

## Load packages and functions for metabolite data analysis
```{r load packages and functions for metabolite data analysis, message=FALSE, fig.show='hide'}
# load packages
source("../libpurzel/func_load_packages_metabolite_data_analysis.R")

# load functions
source("../libpurzel/func_load_functions_metabolite_data_analysis.R")
```


## Load phenotyper results and analytes table
```{r load phenotyper results and analytes table}
phenotyper_result_joined <- read.table("data/phenotyper_result_joined_with_gmd_ids.txt", 
                                       sep="\t", header=TRUE)

analytes_sel_exp_sort <- read.table("data/analytes_7sel_exp_sort_new.txt", 
                                    sep="\t", header=TRUE, allowEscapes = T)
```


## paste file names with experiment_string
```{r paste file names with experiment_string, tidy=TRUE}
file_gmd_values <- paste("data/gmd_values_", experiment_string, ".txt", sep = "")
file_gmd_meta <- paste("data/gmd_meta_", experiment_string, ".txt", sep = "")

file_gmd_values_select <- paste("output/", experiment_string, "/gmd_values_select.txt", sep = "")
file_gmd_values_select_log10 <- paste("output/", experiment_string, "/gmd_values_select_log10.txt", sep = "")
file_gmd_values_select_log10_woNA <- paste("output/", experiment_string, "/gmd_values_select_log10_woNA.txt", sep = "")

file_values_norm_log10_woOutlier <- paste("output/", experiment_string, "/values_norm_log10_woOutlier.txt", sep = "")
file_gmd_values_select_log10_woOutlier <- paste("output/", experiment_string, "/gmd_values_select_log10_woOutlier.txt", sep = "")
```


## Read tables with gmd values and metadata
```{r Read tables with gmd values and metadata}
gmd_values <- read.table(file_gmd_values, sep="\t", header=TRUE, check.names=FALSE)
dim(gmd_values)

gmd_meta <- read.table(file_gmd_meta, sep="\t", header=TRUE)
dim(gmd_meta)
colnames(gmd_meta)
```


## Define subset of selected chromatograms 
### PART: only biological samples -> without blanks, multimix, etc.
```{r subset of chromatograms}
gmd_values_part <- subset(gmd_values, rownames(gmd_values) %in% gmd_meta$chromatogram)
print(dim(gmd_values_part))
```


### remove outlier, see chunk XXX: find outlier
```{r remove outlier, see chunk XXX: find outlier}
# which(rownames(gmd_values_part)=="098BC4DF-28D8-4966-A089-E6F2B0405EDF")
# # 23
# gmd_values_part <- gmd_values_part[-23,]
# 
# which(gmd_meta$chromatogram =="098BC4DF-28D8-4966-A089-E6F2B0405EDF")
# # 23
# gmd_meta <- gmd_meta[-23,]
```


## Define subset of overlapping analytes
### SELECT: `r nrow(analytes_sel_exp_sort)` overlapping analytes regarding 7 TROST experiments, WITHOUT internal standards and contaminations
```{r subset of analytes}
gmd_values_select <- func_get_overlapping_analytes(analytes_sel_exp_sort, gmd_values_part)

write.table(gmd_values_select, file_gmd_values_select, sep="\t")
```


## Replace NAs with minimal values of dataset and calculate LOG10 of raw intensity values 
```{r replace NAs and calc LOG10 of raw values}
# log10 transformation (with NAs)
gmd_values_select_log10 <- log10(gmd_values_select)

# replace NAs with lowest value of dataset
gmd_values_select_woNA <- func_replace_na_with_min_value(gmd_values_select)

# log10 transformation after NA replacement -> without NAs 
gmd_values_select_log10_woNA <- log10(gmd_values_select_woNA)

sum(is.na(gmd_values_select_log10))
sum(is.na(gmd_values_select_log10_woNA))

write.table(gmd_values_select_log10, file_gmd_values_select_log10, sep="\t")
write.table(gmd_values_select_log10_woNA, file_gmd_values_select_log10_woNA, sep="\t")
```


## Calculate percentage of NAs and plot histograms
```{r calculate percentage of NAs and plot histograms}
func_print_na_statistics(gmd_values_select, analytes_sel_exp_sort)

pdf(paste("figures/", experiment_string, "/NAs_hist.pdf", sep=""))
func_plot_na_statistics(gmd_values_select)
dev.off()
```


## Extract BatchID and SequenceID from GMD_id
```{r BatchID and SequenceID}
BatchID <- func_get_batch_ids(gmd_meta)
SequenceID <- func_get_sequence_ids(gmd_meta)
```


## Relevel factors: treatment, cultivar, sample_time and create factors table
```{r relevel factors and factors table}
# relevel factors (treatment, cultivar, sample_time)
gmd_meta <- func_relevel_factors(gmd_meta)

# define tolerance factor
tolerance <- func_create_tolerance_factor(gmd_meta)

# create factors table for treatment, cultivar, sample_time, Dw, Fw, Is, AvgAnnotated, AvgAnnotatedLog10, BatchID, SequenceID
factors <- func_create_factors_table(gmd_meta, SequenceID, BatchID, tolerance)
levels(factors$cultivar)

write.table(factors, 
            paste("output/", experiment_string, "/factors.txt", sep=""), 
            sep="\t")
```


## Normalize Values: Remove Factors by ANOVA models using R script by Jan Lisec
### IIIc: SequenceID + BatchID + LOG10(AvgAnnotated)
```{r normalize values IIIc, warning=FALSE}
values_norm_log10 <- func_normalize(gmd_values_select_log10, factors)

write.table(values_norm_log10, 
            paste("output/", experiment_string, "/values_norm_log10.txt", sep=""), 
            sep="\t")

# matrix without NAs
values_norm_log10_woNA <- func_normalize(gmd_values_select_log10_woNA, factors)
write.table(values_norm_log10_woNA, 
            paste("output/", experiment_string, "/values_norm_log10_woNA.txt", sep=""), 
            sep="\t")
```


## Outlier Detection
```{r outlier detection}
pdf( paste("figures/", experiment_string, "/outlier_hist.pdf", sep="") )
func_hist_outlier(values_norm_log10, threshold = outlier_threshold)
dev.off()

# already normalized matrix
values_norm_log10_woOutlier <- func_replace_outlier(values_norm_log10, 
                                                    threshold = outlier_threshold, 
                                                    original_values = gmd_values_select_log10, 
                                                    output = "normalized")
# original matrix before normalization
gmd_values_select_log10_woOutlier <- func_replace_outlier(values_norm_log10, 
                                                          threshold = outlier_threshold, 
                                                          original_values = gmd_values_select_log10, 
                                                          output = "original")
# before
sum(is.na(values_norm_log10))
# after
sum(is.na(values_norm_log10_woOutlier)) 
sum(is.na(gmd_values_select_log10_woOutlier)) 

write.table(values_norm_log10_woOutlier, file_values_norm_log10_woOutlier, sep = "\t")
write.table(gmd_values_select_log10_woOutlier, file_gmd_values_select_log10_woOutlier, sep = "\t")
```


## Coefficient of Variation --> calculate, print, plot
```{r calculate CV}
# calculate cv values
# INPUT: already normalized values (containing NAs)!
cv_values <- func_calculate_cv(values_norm_log10_woOutlier, factors, 
                               all_factors = all_factors_variable,
                               keep_factors = keep_factors_variable,
                               IA_factors = IA_factors_variable)

# print replicate groups with CV > threshold (e.g. 0.25)
func_print_cv(cv_values, cv_value_threshold)

# plot histogram of cv values per analyte
pdf( paste("figures/", experiment_string, "/cv_values_hist.pdf", sep="") )
func_plot_cv(cv_values)
dev.off()
```


### check normal distribution --> shapiro test and histogram
```{r check normal distribution}
# plot histograms of normalized values per analyte
pdf( paste("figures/", experiment_string, "/values_norm_log10_hist.pdf", sep="") )
func_plot_dist(values_norm_log10_woOutlier)
dev.off()

# shapiro test for normal distribution per analyte
res_shapiro <- func_shapiro_test(values_norm_log10_woOutlier, shapiro_threshold)
```


### aggregate normalized log10 values
```{r aggregate normalized log10 values}
# for matrix with NAs
values_norm_log10_mean <- func_agg_3fac(values_norm_log10_woOutlier, factors, 
                                        "treatment", "sample_time", "cultivar", 
                                        mean, analytes_sel_exp_sort)
values_norm_log10_median <- func_agg_3fac(values_norm_log10_woOutlier, factors, 
                                          "treatment", "sample_time", "cultivar", 
                                          median, analytes_sel_exp_sort)
dim(values_norm_log10_median)


# for matrix without NAs
values_norm_log10_woNA_mean <- func_agg_3fac(values_norm_log10_woNA, factors, 
                                             "treatment", "sample_time", "cultivar", 
                                             mean, analytes_sel_exp_sort)
values_norm_log10_woNA_median <- func_agg_3fac(values_norm_log10_woNA, factors, 
                                               "treatment", "sample_time", "cultivar", 
                                               median, analytes_sel_exp_sort)

write.table(values_norm_log10_mean, paste("output/", experiment_string, "/values_norm_log10_mean.txt", sep=""), sep="\t")
write.table(values_norm_log10_median, paste("output/", experiment_string, "/values_norm_log10_median.txt", sep=""), sep="\t")
write.table(values_norm_log10_woNA_mean, paste("output/", experiment_string, "/values_norm_log10_woNA_mean.txt", sep=""), sep="\t")
write.table(values_norm_log10_woNA_median, paste("output/", experiment_string, "/values_norm_log10_woNA_median.txt", sep=""), sep="\t")
```


## Compare influence of different scaling methods for one dataset on PCA results
```{r compare scaling methods}
pca_norm_log10_pareto_rnipals <- func_prep_pca(values_norm_log10_woOutlier, scale_method = "pareto", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_norm_log10_uv_rnipals <- func_prep_pca(values_norm_log10_woOutlier, scale_method = "uv", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_norm_log10_vector_rnipals <- func_prep_pca(values_norm_log10_woOutlier, scale_method = "vector", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_norm_log10_none_rnipals <- func_prep_pca(values_norm_log10_woOutlier, scale_method = "none", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")




# matrix without NAs
pca_norm_log10_woNA_pareto_rnipals <- func_prep_pca(values_norm_log10_woNA, scale_method = "pareto", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

# compare PCA of matrix with/without NAs
palette(cols_cultivar)
pairs(pca_norm_log10_pareto_rnipals@scores[,1:5], 
      col=factors$cultivar, pch=19, main="pareto scaling")
pairs(pca_norm_log10_woNA_pareto_rnipals@scores[,1:5], 
      col=factors$cultivar, pch=19, main="pareto scaling")
```


### compare scaling methods: PCA plots
```{r compare scaling methods: pca plots}
pdf(paste("figures/", experiment_string, "/PCA_scoresplots_scaling_effect.pdf", sep="") )
palette(cols_cultivar)
pairs(pca_norm_log10_pareto_rnipals@scores[,1:5], col=factors$cultivar, pch=19, main="pareto scaling")
pairs(pca_norm_log10_uv_rnipals@scores[,1:5], col=factors$cultivar, pch=19, main="unit variance scaling")
pairs(pca_norm_log10_vector_rnipals@scores[,1:5], col=factors$cultivar, pch=19, main="vector scaling")
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$cultivar, pch=19, main="no scaling")

palette(cols_treatment)
pairs(pca_norm_log10_pareto_rnipals@scores[,1:5], col=factors$treatment, pch=19, main="pareto scaling")
pairs(pca_norm_log10_uv_rnipals@scores[,1:5], col=factors$treatment, pch=19, main="unit variance scaling")
pairs(pca_norm_log10_vector_rnipals@scores[,1:5], col=factors$treatment, pch=19, main="vector scaling")
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$treatment, pch=19, main="no scaling")

palette(cols_sample_time)
pairs(pca_norm_log10_pareto_rnipals@scores[,1:5], col=factors$sample_time, pch=19, main="pareto scaling")
pairs(pca_norm_log10_uv_rnipals@scores[,1:5], col=factors$sample_time, pch=19, main="unit variance scaling")
pairs(pca_norm_log10_vector_rnipals@scores[,1:5], col=factors$sample_time, pch=19, main="vector scaling")
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$sample_time, pch=19, main="no scaling")
dev.off()
```


## compare influence of different PCA methods for one dataset on PCA results
```{r compare pca methods}
pca_norm_log10_none_rnipals <- func_prep_pca(values_norm_log10_woOutlier, 
                                             scale_method = "none", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_norm_log10_none_bpca <- func_prep_pca(values_norm_log10_woOutlier, 
                                          scale_method = "none", center_option = FALSE, 
                                          pc_number = 5, pca_method = "bpca")

pca_norm_log10_none_ppca <- func_prep_pca(values_norm_log10_woOutlier, 
                                          scale_method = "none", center_option = FALSE, 
                                          pc_number = 5, pca_method = "ppca")

pca_norm_log10_none_svdimpute <- func_prep_pca(values_norm_log10_woOutlier, 
                                               scale_method = "none", center_option = FALSE, 
                                               pc_number = 5, pca_method = "svdImpute")
```


### compare PCA methods: PCA plots
```{r compare pca methods: pca plots}
pdf(paste("figures/", experiment_string, "/PCA_scoresplots_pca_methods_effect.pdf", sep="") )
palette(cols_cultivar)
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$cultivar, pch=19, main="rnipals")
pairs(pca_norm_log10_none_bpca@scores[,1:5], col=factors$cultivar, pch=19, main="bpca")
pairs(pca_norm_log10_none_ppca@scores[,1:5], col=factors$cultivar, pch=19, main="ppca")
pairs(pca_norm_log10_none_svdimpute@scores[,1:5], col=factors$cultivar, pch=19, main="svdImpute")

palette(cols_treatment)
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$treatment, pch=19, main="rnipals")
pairs(pca_norm_log10_none_bpca@scores[,1:5], col=factors$treatment, pch=19, main="bpca")
pairs(pca_norm_log10_none_ppca@scores[,1:5], col=factors$treatment, pch=19, main="ppca")
pairs(pca_norm_log10_none_svdimpute@scores[,1:5], col=factors$treatment, pch=19, main="svdImpute")

palette(cols_sample_time)
pairs(pca_norm_log10_none_rnipals@scores[,1:5], col=factors$sample_time, pch=19, main="rnipals")
pairs(pca_norm_log10_none_bpca@scores[,1:5], col=factors$sample_time, pch=19, main="bpca")
pairs(pca_norm_log10_none_ppca@scores[,1:5], col=factors$sample_time, pch=19, main="ppca")
pairs(pca_norm_log10_none_svdimpute@scores[,1:5], col=factors$sample_time, pch=19, main="svdImpute")
dev.off()
```


## Scatterplots for log-transformed values --> compare with/without NA replacement by minimum
```{r scatterplots pareto scaling + rnipals PCA}
# ANOVA Normalisierung mit log10-Werten 
pdf(paste("figures/", experiment_string, "/PCA_scoresplots_NA_effect.pdf", sep=""), width=12, height=6)

palette(cols_cultivar)
par(mfrow=c(1,2))
plot(pca_norm_log10_pareto_rnipals@scores[,1], pca_norm_log10_pareto_rnipals@scores[,3], 
     cex=1.5, main="ANOVA normalization(IIIc), log10 values",
     col=factors$cultivar, 
     pch=c(16,17)[as.numeric(factors$treatment)], 
     xlab="PC1", ylab="PC3")


plot(pca_norm_log10_woNA_pareto_rnipals@scores[,1], pca_norm_log10_woNA_pareto_rnipals@scores[,3], 
     cex=1.5, main="ANOVA normalization(IIIc), log10 values wo NA",
     col=factors$cultivar, 
     pch=c(16,17)[as.numeric(factors$treatment)], 
     xlab="PC1", ylab="PC3")

legend("topright", levels(factors$cultivar), fill=cols_cultivar, cex=0.8)
legend("bottomright", levels(factors$treatment), pch=factors$treatment, cex=0.8)

# colour: sample time
palette(cols_sample_time)
par(mfrow=c(1,2))
plot(pca_norm_log10_pareto_rnipals@scores[,1], pca_norm_log10_pareto_rnipals@scores[,2], 
     cex=1.5, main="ANOVA normalization(IIIc), log10 values",
     col=factors$sample_time, 
     pch=c(16,17)[as.numeric(factors$treatment)], 
     xlab="PC1", ylab="PC2")


plot(pca_norm_log10_woNA_pareto_rnipals@scores[,1], pca_norm_log10_woNA_pareto_rnipals@scores[,2], 
     cex=1.5, main="ANOVA normalization(IIIc), log10 values wo NA",
     col=factors$sample_time, 
     pch=c(16,17)[as.numeric(factors$treatment)], 
     xlab="PC1", ylab="PC2")

legend("topright", levels(factors$sample_time), fill=cols_sample_time, cex=0.8)
legend("bottomright", levels(factors$treatment), pch=factors$treatment, cex=0.8)

dev.off()

par(mfrow=c(1,1))
```


## ANOVA with 3 factors (without interaction): treatment, cultivar, sample_time
```{r ANOVA with 3 factors (without interaction)}
res_anova_adj <- func_anova_3fac(values_norm_log10_woOutlier, factors, "treatment", "cultivar", "sample_time", 0.01, analytes_sel_exp_sort)

write.table(res_anova_adj, paste("output/", experiment_string, "/res_anova_adj.txt", sep=""), sep="\t")
```


## Boxplots of normalized values per analyte using 1 factor
```{r boxplots of normalized values per analyte using 1 factor}
pdf(paste("figures/", experiment_string, "/boxplot_treatment.pdf", sep="") )
func_boxplot_1fac(values_norm_log10_woOutlier, factors, "treatment", res_anova_adj, cols_treatment, analytes_sel_exp_sort)
dev.off()

pdf(paste("figures/", experiment_string, "/boxplot_sample_time.pdf", sep="") )
func_boxplot_1fac(values_norm_log10_woOutlier, factors, "sample_time", res_anova_adj, cols_sample_time, analytes_sel_exp_sort)
dev.off()

pdf(paste("figures/", experiment_string, "/boxplot_cultivar.pdf", sep="") )
func_boxplot_1fac(values_norm_log10_woOutlier, factors, "cultivar", res_anova_adj, cols_cultivar, analytes_sel_exp_sort)
dev.off()
```


## ANOVA for 2 factors: treatment and sample time + interaction
```{r ANOVA with 2 factors (with interaction)}
res_anova2_adj <- func_anova_2fac_ia(values_norm_log10_woOutlier, factors, "treatment", "sample_time", 0.01, analytes_sel_exp_sort)

write.table(res_anova2_adj, paste("output/", experiment_string, "/res_anova2_adj.txt", sep=""), sep="\t")
```


## Boxplots of normalized values per analyte using 2 factors
```{r boxplots of normalized values per analyte using 2 factors}
pdf(paste("figures/", experiment_string, "/boxplot_treatment_sample_time.pdf", sep="") )
par(mar=c(7, 4.1, 7, 2.1))
func_boxplot_2fac(normalized_values = values_norm_log10_woOutlier, 
                  trial_factors = factors, 
                  factor1 = "treatment", 
                  factor2 = "sample_time", 
                  res_anova_adj = res_anova2_adj, 
                  cols = cols_treatment_sample_time,
                  names_factors = names_treatment_sample_time_2,
                  analytes_sel_exp_sort)
dev.off()
```


## only late/before samples
**analysis for late/before sample subset is only executed for some samples: depends on variable `do_agg_late_before_samples`**
```{r only late/before samples}

if(do_agg_late_before_samples == 1) {
  values_norm_log10_late_before <- subset(values_norm_log10_woOutlier, factors$sample_time=="late/before")
  dim(values_norm_log10_late_before)
      
  factors_late_before <- subset(factors, factors$sample_time=="late/before")
  factors_late_before$sample_time <- droplevels(factors_late_before$sample_time)
  
  write.table(values_norm_log10_late_before, 
              paste("output/", experiment_string, "/values_norm_log10_late_before.txt", sep=""), 
              sep="\t")
  write.table(factors_late_before,
              paste("output/", experiment_string, "/factors_late_before.txt", sep=""), 
              sep="\t")
  
  # un-normalized values
  
  gmd_values_select_log10_late_before <- subset(gmd_values_select_log10, factors$sample_time=="late/before")
  write.table(gmd_values_select_log10_late_before, 
              paste("output/", experiment_string, "/gmd_values_select_log10_late_before.txt", sep=""), 
              sep="\t")

  } else { 
  print("subset only late/before samples NOT executed") 
  }
```


## aggregate only late/before samples
**analysis for late/before sample subset is only executed for some samples: depends on variable `do_agg_late_before_samples`**
```{r aggregate only late/before samples}

if(do_agg_late_before_samples == 1)
  {
  values_norm_log10_late_before_mean <- func_agg_2fac(values_norm_log10_late_before, 
                                                      factors_late_before, 
                                                      "cultivar", "treatment", 
                                                      mean, analytes_sel_exp_sort)
  
  values_norm_log10_late_before_mean <- cbind(sample_names_variable, 
                                              values_norm_log10_late_before_mean[,-c(1,2)])
  dim(values_norm_log10_late_before_mean)
  write.table(values_norm_log10_late_before_mean, 
              paste("output/", experiment_string, "/values_norm_log10_late_before_mean.txt", sep=""), 
              sep="\t")
  
} else { print("aggregate only late/before samples NOT executed") }
```
