---
title: Merge GC-MS data from three field experiments
author: "Heike Sprenger"
date: "November 21, 2015"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_depth: 4
---


# Set pander and knitr options
```{r set pander and knitr options, message=FALSE}
library(knitr)
library(pander)
library(colorRamps)

# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width = 5, fig.height = 5, cache = F, 
               highlight = T, fig.show = "asis")
opts_knit$set(root.dir = '../')

#setwd("~/work/repos/trost_metabolomics")
#load("merge_field_experiments_late.RData")
```


# Load packages and functions for metabolite data analysis
```{r load packages and functions for metabolite data analysis, message=FALSE, fig.show='hide'}
# load packages
source("../functions/func_load_packages_metabolite_data_analysis.R")

# load functions
source("../functions/func_load_functions_metabolite_data_analysis.R")
```


# Load data
## Load analytes table
this table comes from ``gmd_analytes.Rmd``
```{r load analytes table}
analytes_sel_exp_sort <- read.table("data/analytes_table_7exp_overlap_select_ordered.txt", 
                                    sep = "\t", header = T, allowEscapes = T)
```


## Load sample information
these tables come from ``gmd_data_analysis.Rmd``
```{r load sample information}
mpi_field_2011_factors <- read.table("output/mpi_field_2011/factors.txt", 
                                     sep = "\t", header = T, row.names = 1)
mpi_field_2012_factors <- read.table("output/mpi_field_2012/factors.txt", 
                                     sep = "\t", header = T, row.names = 1)
jki_field_2012_factors <- read.table("output/jki_field_2012/factors.txt", 
                                     sep = "\t", header = T, row.names = 1)
```


## Load data: log-transformed, with NAs, selected samples and selected overlapping analytes (107)
```{r load data}
mpi_field_2011_values <- read.table("output/mpi_field_2011/gmd_values_select_log10.txt", 
                                    sep = "\t", header = T, row.names = 1, check.names = F)

mpi_field_2012_values <- read.table("output/mpi_field_2012/gmd_values_select_log10.txt", 
                                    sep = "\t", header = T, row.names = 1, check.names = F)

jki_field_2012_values <- read.table("output/jki_field_2012/gmd_values_select_log10.txt", 
                                    sep = "\t", header = T, row.names = 1, check.names = F)
```


# Select only samples from late sampling and check cultivars
```{r select only samples from late sampling and check cultivars}

func_select_samples <- function(dataframe, factors, values1 = "late", values2 = check_names){
  dataframe_subset <- droplevels(subset(dataframe, factors$sample_time == values1 & factors$cultivar %in% values2))
}

# values
mpi_field_2011_values_late_check <- func_select_samples(mpi_field_2011_values, mpi_field_2011_factors)
mpi_field_2012_values_late_check <- func_select_samples(mpi_field_2012_values, mpi_field_2012_factors)
jki_field_2012_values_late_check <- func_select_samples(jki_field_2012_values, jki_field_2012_factors)

# factors
mpi_field_2011_factors_late_check <- func_select_samples(mpi_field_2011_factors, mpi_field_2011_factors)
mpi_field_2012_factors_late_check <- func_select_samples(mpi_field_2012_factors, mpi_field_2012_factors)
jki_field_2012_factors_late_check <- func_select_samples(jki_field_2012_factors, jki_field_2012_factors)
```


# Combine data
## Combine sample information tables by rows
```{r combine sample information tables}
# all samples
all_factors <- rbind(mpi_field_2011_factors, 
                     mpi_field_2012_factors, 
                     jki_field_2012_factors)
dim(all_factors)

# all field trials (late time point, check cultivars)
factors <- rbind(mpi_field_2011_factors_late_check, 
                     mpi_field_2012_factors_late_check, 
                     jki_field_2012_factors_late_check)
dim(factors)

length(levels(factors$BatchID)) 
# 23
table(factors$BatchID)

levels(factors$treatment)
# "control" "drought stress"

levels(factors$sample_time)
# only late!

# reorder cultivar factor (use: check_names_ordered)
factors$cultivar <- factor(factors$cultivar, levels = check_names_ordered)
levels(factors$cultivar)

# create vector for trial name
factors$trial <- as.factor(c(rep("mpi_field_2011", 64),
                             rep("mpi_field_2012", 64),
                             rep("jki_field_2012", 16)))

# create vector for tolerance
factors$tolerance <- func_create_tolerance_factor(factors)
table(factors$tolerance, factors$cultivar)

write.table(factors, "output/merge_field_experiments_late/factors.txt", sep = "\t")
```


## Combine value tables by rows 
```{r combine value tables}
# only late timepoint, check cultivars
values <- rbind(mpi_field_2011_values_late_check,
                mpi_field_2012_values_late_check,
                jki_field_2012_values_late_check)
dim(values)
# 144 107




# all values
all_values <- rbind(mpi_field_2011_values,
                    mpi_field_2012_values,
                    jki_field_2012_values)
dim(all_values)
# 1047 107
```


# Calculate percentage of NAs and plot histograms
**30% NAs corresponds to more the 43 NAs (of 144 samples)**
**40% NAs corresponds to more the 58 NAs (of 144 samples)**
```{r calculate percentage of NAs}

func_print_na_statistics(values, 0.3, analytes_sel_exp_sort)
func_print_na_statistics(values, 0.4, analytes_sel_exp_sort)

pdf("figures/merge_field_experiments_late/NAs_hist.pdf")
func_plot_na_statistics(values, 0.3)
dev.off()
```


# Normalization: apply removeFactors function
```{r apply removeFactors function}
values_norm <- func_normalize(values, factors, 
                              facs=c("cultivar", "treatment", "SequenceID", "BatchID", "log10_AvgAnnotated"),
                              keep=c("cultivar", "treatment"))

write.table(values_norm, "output/merge_field_experiments_late/values_norm.txt", sep="\t")




# all values
all_values_norm <- func_normalize(all_values, all_factors, 
                              facs=c("cultivar", "treatment", "SequenceID", "BatchID", "log10_AvgAnnotated"),
                              keep=c("cultivar", "treatment"))
```


# Look for outliers after normalization of 3 merged data sets
```{r outlier detection}
pdf("figures/merge_field_experiments_late/outlier_hist.pdf")
func_hist_outlier(values_norm, threshold=1e-6)
dev.off()

# keep possible outliers for now
```


#### check normal distribution --> shapiro test and histogram
```{r check normal distribution}
source("../../functions/func_check_norm_dist.R")

### plot histograms of normalized values per analyte
pdf("../figures/merge_field_experiments_late/values_norm_log10_hist.pdf")
func_plot_dist(values_norm_log10)
dev.off()

# shapiro test for normal distribution per analyte
res_shapiro <- func_shapiro_test(values_norm_log10, 1e-6)
```


# Perform PCA to check effect of normalization
## Prep for PCA
```{r prep for PCA}
# BEFORE normalization
pca_pareto_rnipals <- func_prep_pca(values, scale_method = "pareto", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_none_rnipals <- func_prep_pca(values, scale_method = "none", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")


# AFTER normalization
pca_norm_pareto_rnipals <- func_prep_pca(values_norm, scale_method = "pareto", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")

pca_norm_none_rnipals <- func_prep_pca(values_norm, scale_method = "none", center_option = FALSE, 
                                             pc_number = 5, pca_method = "rnipals")
```


## Plot effect of missing value imputation by PCA 
```{r plot effect of missing value imputation by PCA}
# analyte 89: proline
sum(is.na(values_norm[,89]))
boxplot(values_norm[,89] ~ factors$treatment) # with NAs

boxplot(pca_norm_none_rnipals@completeObs[,89] ~ factors$treatment) # with NAs --> missing value imputation by PCA
boxplot(pca_norm_pareto_rnipals@completeObs[,89] ~ factors$treatment) # with NAs --> missing value imputation by PCA
# different scaling due to pareto scaling!
```


## PCA plots all field trials
```{r PCA plot all field trials}
pdf("figures/merge_field_experiments_late/PCA_scoresplots_normalization_effect.pdf")
par(mar=c(4.5, 4.5, 2, 0.5))
# trial
palette( brewer.pal(3, "Dark2"))
func_5pairs_plot(pca_none_rnipals, factors, "trial", 19, "trial effect, before normalization")
func_5pairs_plot(pca_norm_none_rnipals, factors, "trial", 19, "trial effect, after normalization")
func_5pairs_plot(pca_norm_pareto_rnipals, factors, "trial", 19, "trial effect, after normalization (pareto scaling)")

# cultivar
palette(cols_cultivar_check)
func_5pairs_plot(pca_none_rnipals, factors, "cultivar", 19, "cultivar effect, before normalization")
func_5pairs_plot(pca_norm_none_rnipals, factors, "cultivar", 19, "cultivar effect, after normalization")
func_5pairs_plot(pca_norm_pareto_rnipals, factors, "cultivar", 19, "cultivar effect, after normalization (pareto scaling)")

# treatment
palette(cols_treatment)
func_5pairs_plot(pca_none_rnipals, factors, "treatment", 19, "treatment effect, before normalization")
func_5pairs_plot(pca_norm_none_rnipals, factors, "treatment", 19, "treatment effect, after normalization")
func_5pairs_plot(pca_norm_pareto_rnipals, factors, "treatment", 19, "treatment effect, after normalization (pareto scaling)")

# trial
palette( brewer.pal(3, "Dark2"))
func_pca_plot_sym(pca_none_rnipals, 1, 2, factors, "trial", c(19,17), 
              "treatment", 1.5, "topleft", 0.8, "topright", 0.8, "before normalization", 
              legend.text = c("JKI field 2011", "MPI field 2011", "MPI field 2012"))

func_pca_plot_sym(pca_norm_none_rnipals, 1, 2, factors, "trial", c(19,17), 
              "treatment", 1.5, "bottomleft", 0.8, "topright", 0.8, "after normalization",
              legend.text = c("JKI field 2011", "MPI field 2011", "MPI field 2012"))

# cultivar
palette(cols_cultivar)
func_pca_plot(pca_norm_none_rnipals, 1, 2, factors, "cultivar", 19, 1.5, "bottomleft", 1)
func_pca_plot(pca_norm_none_rnipals, 1, 3, factors, "cultivar", 19, 1.5, "bottomright", 1)
func_pca_plot(pca_norm_pareto_rnipals, 1, 2, factors, "cultivar", 19, 1.5, "bottomleft", 1)

# treatment
palette(cols_treatment)
func_pca_plot(pca_norm_none_rnipals, 1, 2, factors, "treatment", 19, 1.5, "bottomleft", 1)
func_pca_plot(pca_norm_pareto_rnipals, 1, 2, factors, "treatment", 19, 1.5, "bottomleft", 1)

dev.off()
```


## PCA plots: cultivar effect
```{r PCA plots: cultivar effect}
palette(cols_cultivar_check)

pdf("figures/merge_field_experiments_late/PCA_scoresplots_cultivar_effect.pdf",6,6)

func_5pairs_plot(pca_norm_none_rnipals, factors, "cultivar", 19, "cultivar effect")
func_5pairs_plot_sym(pca_norm_none_rnipals, factors, "cultivar", c(19,17), "treatment", "cultivar / treatment effect")

# PC1 vs PC2
func_pca_plot_sym(pca_norm_none_rnipals, 1, 2, factors, "cultivar", c(19,17), 
              "treatment", 1.5, "bottomright", 0.8, "topright", 0.8, "cultivar / treatment effect")
# PC1 vs PC3
func_pca_plot_sym(pca_norm_none_rnipals, 1, 3, factors, "cultivar", c(19,17), 
              "treatment", 1.5, "bottomright", 0.8, "topright", 0.8, "cultivar / treatment effect")
# PC2 vs PC3
func_pca_plot_sym(pca_norm_none_rnipals, 2, 3, factors, "cultivar", c(19,17), 
              "treatment", 1.5, "bottomleft", 0.8, "topleft", 0.8, "cultivar / treatment effect")

dev.off()

#######################################

# for Phd-thesis: cultivar effect, with treatment as symbol
#pdf("../../Doktorarbeit/figures/gcms_all_field_cultivar_treatment.pdf", width=6, height=6)
palette(cols_cultivar2)
par(mar=c(4.5, 4.5, 0.5, 0.5))
func_pca_plot_sym(pca_norm_none_rnipals, 1, 2, factors, "cultivar", c(19,17), 
              "treatment", 2, "topright", 1.2, "topleft", 1.2)
#dev.off()

# for Publication
#pdf("../../TORST/Manuskripte/tba/gcms_all_field_cultivar_treatment_new.pdf", width=6, height=6)
palette(cols_treatment)
par(mar=c(4.5, 4.5, 1.5, 0.5))
func_pca_plot_sym(pca_norm_none_rnipals, 1, 2, factors, "treatment", 
                  symbols = c(15, 16, 17, 18), 
                  "cultivar", 2, "topleft", 1.2, "topright", 1.2, 
                  ymin = -2.5, ymax = 2.5)
#dev.off()


#png("../../TROST/Manuskripte/tba/gcms_all_field_cultivar_treatment_new.png", width=2000, height=2000, res=300)
palette(cols_treatment)
par(mar=c(4.5, 4.5, 1.5, 0.5))
func_pca_plot_sym(pca_norm_none_rnipals, 1, 2, factors, "treatment", 
                  symbols = c(15, 16, 17, 18), 
                  "cultivar", symbol_size = 2, "bottomleft", 1.5, 
                  "topright", 1.5, ymin = -2.5, ymax = 2.5)
#mtext('C', side=3, at=-2.7, line=0, outer=F, cex=1.5)
#dev.off()
```


# Only samples of one cultivar
## Only Desiree samples
```{r only Desiree samples}
# all_field_merge_desiree <- subset(all_field_merge_IIIc, factors$cultivar=="DESIREE")
# factors_desiree <- subset(factors, factors$cultivar=="DESIREE")
# 
# all_field_merge_desiree <- prep(all_field_merge_desiree, scale = "none", center = FALSE) # after normalization
# 
# # PCA
# all_field_merge_rnipals_desiree <- pca(all_field_merge_desiree, nPcs=10, method="rnipals")
# 
# # R2cum
# all_field_merge_rnipals_desiree@R2
# all_field_merge_rnipals_desiree@R2cum
# 
# pdf("../figures/PCA_scoresplots_all_field_merge_treatment_effect_desiree.pdf", 5,5)
# pairs(all_field_merge_rnipals_desiree@scores[,1:5], col=factors_desiree$treatment, main="treatment effect", pch=19)
# 
# pairs(all_field_merge_rnipals_desiree@scores[,1:5], col=factors_desiree$trial, main="trial effect", pch=19)
# 
# plot(all_field_merge_rnipals_desiree@scores[,1], all_field_merge_rnipals_desiree@scores[,2], 
#      col=factors_desiree$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_desiree@scores[,1], all_field_merge_rnipals_desiree@scores[,3], 
#      col=factors_desiree$treatment, main="treatment effect", pch=19)
# dev.off()
```

## Only Saturna samples
```{r only Saturna samples}
# all_field_merge_saturna <- subset(all_field_merge_IIIc, factors$cultivar=="SATURNA")
# factors_saturna <- subset(factors, factors$cultivar=="SATURNA")
# 
# all_field_merge_saturna <- prep(all_field_merge_saturna, scale = "none", center = FALSE) # after normalization
# 
# # PCA
# all_field_merge_rnipals_saturna <- pca(all_field_merge_saturna, nPcs=10, method="rnipals")
# 
# # R2cum
# all_field_merge_rnipals_saturna@R2
# all_field_merge_rnipals_saturna@R2cum
# 
# pdf("../figures/PCA_scoresplots_all_field_merge_treatment_effect_saturna.pdf",5,5)
# pairs(all_field_merge_rnipals_saturna@scores[,1:5], col=factors_saturna$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_saturna@scores[,1], all_field_merge_rnipals_saturna@scores[,2], 
#      col=factors_saturna$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_saturna@scores[,1], all_field_merge_rnipals_saturna@scores[,3], 
#      col=factors_saturna$treatment, main="treatment effect", pch=19)
# dev.off()
```

## Only Milva samples
```{r only Milva samples}
# all_field_merge_milva <- subset(all_field_merge_IIIc, factors$cultivar=="MILVA")
# factors_milva <- subset(factors, factors$cultivar=="MILVA")
# 
# all_field_merge_milva <- prep(all_field_merge_milva, scale = "none", center = FALSE) # after normalization
# 
# # PCA
# all_field_merge_rnipals_milva <- pca(all_field_merge_milva, nPcs=10, method="rnipals")
# 
# # R2cum
# all_field_merge_rnipals_milva@R2
# all_field_merge_rnipals_milva@R2cum
# 
# pdf("../figures/PCA_scoresplots_all_field_merge_treatment_effect_milva.pdf",5,5)
# pairs(all_field_merge_rnipals_milva@scores[,1:5], col=factors_milva$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_milva@scores[,1], all_field_merge_rnipals_milva@scores[,2], 
#      col=factors_milva$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_milva@scores[,1], all_field_merge_rnipals_milva@scores[,3], 
#      col=factors_milva$treatment, main="treatment effect", pch=19)
# dev.off()
```

## Only Alegria samples
```{r only Alegria samples}
# all_field_merge_alegria <- subset(all_field_merge_IIIc, factors$cultivar=="ALEGRIA")
# factors_alegria <- subset(factors, factors$cultivar=="ALEGRIA")
# 
# all_field_merge_alegria <- prep(all_field_merge_alegria, scale = "none", center = FALSE) # after normalization
# 
# # PCA
# all_field_merge_rnipals_alegria <- pca(all_field_merge_alegria, nPcs=10, method="rnipals")
# 
# # R2cum
# all_field_merge_rnipals_alegria@R2
# all_field_merge_rnipals_alegria@R2cum
# 
# pdf("../figures/PCA_scoresplots_all_field_merge_treatment_effect_alegria.pdf",5,5)
# pairs(all_field_merge_rnipals_alegria@scores[,1:5], col=factors_alegria$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_alegria@scores[,1], all_field_merge_rnipals_alegria@scores[,2], 
#      col=factors_alegria$treatment, main="treatment effect", pch=19)
# 
# plot(all_field_merge_rnipals_alegria@scores[,1], all_field_merge_rnipals_alegria@scores[,3], 
#      col=factors_alegria$treatment, main="treatment effect", pch=19)
# dev.off()
```


# ANOVA, boxplots & t-test
## ANOVA for 2 factors: treatment * cultivar (with interaction)
```{r ANOVA with 2 factors (with interaction)}
res_anova_treatment_cultivar <- func_anova_2fac_ia(values_norm, factors, "treatment", "cultivar", 0.01, analytes_sel_exp_sort$Name)

res_anova_treatment_cultivar_sig_treat <- which(res_anova_treatment_cultivar[,1] < 0.01)
res_anova_treatment_cultivar_sig_cul <- which(res_anova_treatment_cultivar[,2] < 0.01)
res_anova_treatment_cultivar_sig_both <- intersect (which(res_anova_treatment_cultivar[,1] < 0.01), 
                                                    which(res_anova_treatment_cultivar[,2] < 0.01))

write.table(res_anova_treatment_cultivar, "output/merge_field_experiments_late/res_anova_treatment_cultivar.txt", sep="\t")
```


## ANOVA with control samples only
```{r ANOVA with control samples only}
values_norm_control <- subset(values_norm, factors$treatment == "control")
factors_control <- subset(factors, factors$treatment == "control")

# ANOVA: cultivar
res_anova_control_cultivar <- func_anova_1fac(values_norm_control, factors_control, "cultivar", 0.01, analytes_sel_exp_sort$Name)

res_anova_control_cultivar_sig <- which(res_anova_control_cultivar < 0.01)
# 59

#write.table(res_anova_control_cultivar, "output/merge_field_experiments_late/res_anova_control_cultivar.txt", sep="\t")
```


## Boxplots of normalized values per analyte using 2 factors
```{r boxplots of normalized values per analyte using 2 factors}
pdf("figures/merge_field_experiments_late/boxplot_treatment_cultivar.pdf", width=7, height=8)
par(mar=c(7, 4.1, 7, 2.1))
func_boxplot_2fac(normalized_values = values_norm, 
                  trial_factors = factors, 
                  factor1 = "treatment", 
                  factor2 = "cultivar", 
                  res_anova_adj = res_anova_treatment_cultivar, 
                  cols = cols_cultivar_treatment,
                  names_factors = names_treatment_cultivar_reordered,
                  analytes_sel_exp_sort$Name)

dev.off()

################################

pdf("figures/merge_field_experiments_late/boxplot_treatment.pdf")
func_boxplot_1fac(values_norm, 
                  factors, 
                  "treatment", 
                  res_anova_treatment_cultivar, 
                  cols_treatment, 
                  analytes_sel_exp_sort$Name)
dev.off()
```


## t-test: control vs. stress, separately for cultivars
```{r t-test control vs. stress}
res_ttest_treatment <- func_ttest_treatment_all(values_norm, factors, 0.01)
# 53

res_ttest_alegria <- func_ttest_treatment(values_norm, factors, fac1 = "cultivar", val1 = "Alegria", 0.01)
res_ttest_milva <- func_ttest_treatment(values_norm, factors, fac1 = "cultivar", val1 = "Milva", 0.01)
res_ttest_desiree <- func_ttest_treatment(values_norm, factors, fac1 = "cultivar", val1 = "Desiree", 0.01)
res_ttest_saturna <- func_ttest_treatment(values_norm, factors, fac1 = "cultivar", val1 = "Saturna", 0.01)

res_ttest_idx <- order(res_ttest_treatment)
head(analytes_sel_exp_sort[res_ttest_idx, "Name"], n=20)

# OVERLAP among cultivars (control vs. stress)
intersect_sens <- intersect(which(res_ttest_alegria < 0.01), 
                            which(res_ttest_milva < 0.01))
length(intersect_sens)
# 15

intersect_tol <- intersect(which(res_ttest_desiree < 0.01), 
                           which(res_ttest_saturna < 0.01))
length(intersect_tol)
# 16

intersect_cultivar <- intersect(intersect_sens, intersect_tol)
length(intersect_cultivar)
# 11

analytes_sel_exp_sort$Name[intersect_cultivar]

# union across all cultivars
union_cultivar <- sort(union(union(which(res_ttest_alegria < 0.01), 
                                   which(res_ttest_milva < 0.01)), 
                             union(which(res_ttest_desiree < 0.01), 
                                   which(res_ttest_saturna < 0.01))))
length(union_cultivar)
# 36

length( intersect(which(res_ttest_treatment < 0.01), union_cultivar)) # 31
length( setdiff(which(res_ttest_treatment < 0.01), union_cultivar)) # 22
length( setdiff(union_cultivar, which(res_ttest_treatment < 0.01))) # 5

res_ttest_treatment_specific <- setdiff(which(res_ttest_treatment < 0.01), union_cultivar)

length( union(which(res_ttest_treatment < 0.01), union_cultivar)) # 58
```


# Reverse log10-transformation
```{r reverse log10-transformation}
values_norm_rev <- 10^(values_norm)
```


# Calculate log2FC: up or down regulated
** use log10 reverse transformed values for log2FC calculation **
```{r calculate log2FC}
source("../../functions/func_log2FC_ttest.R")

# across all cultivars!
log2FC_treatment <- func_log2FC_1fac(values_norm_rev, factors, average_func = median)

# per cultivar
log2FC_alegria <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "cultivar", fac1_val = "Alegria",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")

log2FC_milva <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "cultivar", fac1_val = "Milva",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")

log2FC_desiree <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "cultivar", fac1_val = "Desiree",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")

log2FC_saturna <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "cultivar", fac1_val = "Saturna",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")
```

## Up or down regulated
```{r up or down regulated}
# get a factor with the value up or down for all analytes
log2FC_up_down_treatment <- func_log2FC_up_down(log2FC_treatment)

log2FC_up_down_alegria <- func_log2FC_up_down(log2FC_alegria)
log2FC_up_down_milva <- func_log2FC_up_down(log2FC_milva)
log2FC_up_down_desiree <- func_log2FC_up_down(log2FC_desiree)
log2FC_up_down_saturna <- func_log2FC_up_down(log2FC_saturna)

# get a list with ALL analytes that are up or down
log2FC_dir_alegria <- func_log2FC_dir(log2FC_alegria)
log2FC_dir_milva <- func_log2FC_dir(log2FC_milva)
log2FC_dir_desiree <- func_log2FC_dir(log2FC_desiree)
log2FC_dir_saturna <- func_log2FC_dir(log2FC_saturna)

# get a list with significantly changed analytes that are up or down
log2FC_dir_sig_alegria <- func_log2FC_dir_sig(log2FC_dir_alegria, res_ttest_alegria, 0.01)
log2FC_dir_sig_milva <- func_log2FC_dir_sig(log2FC_dir_milva, res_ttest_milva, 0.01)
log2FC_dir_sig_desiree <- func_log2FC_dir_sig(log2FC_dir_desiree, res_ttest_desiree, 0.01)
log2FC_dir_sig_saturna <- func_log2FC_dir_sig(log2FC_dir_saturna, res_ttest_saturna, 0.01)
```


## Volcano plot: log2FC vs. t-test p-value
```{r volcano plot: log2FC vs. t-test p-value}
pdf("figures/merge_field_experiments_late/volcano_plots_cultivars.pdf", 6, 6)
par(mar=c(4.5, 4.5, 0.5, 0.5))

func_volcano_plot(res_ttest_alegria, log2FC_alegria)
func_volcano_plot(res_ttest_milva, log2FC_milva)
func_volcano_plot(res_ttest_desiree, log2FC_desiree)
func_volcano_plot(res_ttest_saturna, log2FC_saturna)

dev.off()
```


## Combine t-test results with log2FC
```{r combine t-test results with log2FC}
colnames(analytes_sel_exp_sort)
res_ttest_all <- cbind(analytes_sel_exp_sort[,c(3,4)],
                       res_ttest_milva, log2FC_milva, log2FC_up_down_milva,
                       res_ttest_alegria, log2FC_alegria, log2FC_up_down_alegria, 
                       res_ttest_desiree, log2FC_desiree, log2FC_up_down_desiree,
                       res_ttest_saturna, log2FC_saturna, log2FC_up_down_saturna,
                       res_ttest_treatment)

write.table(res_ttest_all, "output/merge_field_experiments_late/res_ttest_control_vs_stress.txt", sep="\t", col.names=NA, row.names=T)

res_ttest_p <- cbind(p_milva = res_ttest_milva, p_alegria = res_ttest_alegria,
                     p_desiree = res_ttest_desiree, p_saturna = res_ttest_saturna)

head(res_ttest_p)
```


## Compare lists of up/down regulated analytes
```{r compare lists of up/down regulated analytes}
# compare Alegria and Milva
# UP
func_compare_2lists_up(log2FC_dir_sig_alegria, log2FC_dir_sig_milva)
# DOWN
func_compare_2lists_down(log2FC_dir_sig_alegria, log2FC_dir_sig_milva)


# compare Desiree and Saturna
# UP
func_compare_2lists_up(log2FC_dir_sig_desiree, log2FC_dir_sig_saturna)
# DOWN
func_compare_2lists_down(log2FC_dir_sig_desiree, log2FC_dir_sig_saturna)
```


## Indices of not-significantly regulated analytes
```{r indices of not-significantly regulated analytes}
not_sig_sens <- intersect(which(res_ttest_alegria > 0.01), which(res_ttest_milva > 0.01))
not_sig_tol <- intersect(which(res_ttest_desiree > 0.01), which(res_ttest_saturna > 0.01))
not_sig <- intersect(not_sig_sens, not_sig_tol)
not_sig <- intersect(not_sig, which(res_ttest_treatment > 0.01))
length(not_sig)
# 49 metabolites are not changed at any timepoint, 58 remain
write.table(not_sig, "output/merge_field_experiments_late/not_sig_regulated_analytes.txt", sep="\t")
```


# Aggregate normalized values for heatmap ONLY late samples
```{r aggregate normalized values ONLY late/before samples}
# for matrix with NAs using 2 factors (treatment, cultivar)
# MEDIAN
values_norm_median <- func_agg_2fac(values_norm, factors, "cultivar", "treatment", median, analytes_sel_exp_sort)
dim(values_norm_median)
# 8 samples (rows), 108 (1 sampleID, 107 analytes, columns)

# export TRANSPOSED matrix for heatmap
values_norm_median_t <- t(values_norm_median[,-1])
colnames(values_norm_median_t) <- values_norm_median$sample
dim(values_norm_median_t)
# 107 analytes (rows), 8 samples (columns)

write.table(values_norm_median_t, 
            "output/merge_field_experiments_late/values_norm_log10_median_for_heatmap.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Reverse log-transformation
```{r reverse log-transformation}
values_norm_median_rev <- 10^(values_norm_median[,-1]) # without sample names
dim(values_norm_median_rev)
# 8 samples (rows), 107 analytes (columns)

## samples are in rows, analytes in columns
## for transformation: samples should be in columns and analytes in rows --> row-wise median is median over all samples of 1 analyte

# transpose matrix
values_norm_median_rev_t <- t(values_norm_median_rev)
dim(values_norm_median_rev_t)
# 107 analytes (rows), 8 samples (columns)
colnames(values_norm_median_rev_t) <- values_norm_median$sample
```


# Calculation of log-median-ratio
```{r calculation of log-median-ratio}
values_norm_median_rev_transformed <- func_log_transform(values_norm_median_rev_t)
dim(values_norm_median_rev_transformed)
# 107 analytes, 8 samples

# export matrix for heatmap
write.table(values_norm_median_rev_transformed, 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_transformed_for_heatmap.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Calculation of log2-fold-change
```{r calculation of log2-fold-change}
# manual calculation
colnames(values_norm_median_rev_t)[c(1,5)]
log2(values_norm_median_rev_t[1,5] / values_norm_median_rev_t[1,1])

colnames(values_norm_median_rev_t)[c(4,8)]
log2(values_norm_median_rev_t[1,8] / values_norm_median_rev_t[1,4])

values_norm_median_rev_t_log2FC <- log2_fold_change(values_norm_median_rev_t)
dim(values_norm_median_rev_t_log2FC)
range(values_norm_median_rev_t_log2FC, na.rm=TRUE)

# change colnames ("trial", "cultivar", "sample_time")
colnames(values_norm_median_rev_t_log2FC) <- levels(factors$cultivar)

# export matrix for heatmap
write.table(values_norm_median_rev_t_log2FC, 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_t_log2FC_for_heatmap.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Change not significant values to NA
```{r change not significant values to NA}
dim(values_norm_median_rev_t_log2FC)
dim(res_ttest_p)

log2FC_cultivars_sig <- values_norm_median_rev_t_log2FC

for (i in 1:107){
  for (j in 1:4){
    if(is.na(res_ttest_p[i,j])){
      log2FC_cultivars_sig[i,j] <- NA
    }
    else if (res_ttest_p[i,j] > 0.01){
      log2FC_cultivars_sig[i,j] <- NA
    }
  }
}

log2FC_cultivars_sig [union_cultivar,]

# only 36 metabolites that changed per cultivar!
# write.table(log2FC_cultivars_sig[union_cultivar,], 
#             "../heatmaps/merge_field_experiments_late/log2FC_cultivars_sig_for_heatmap.txt", 
#             sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Significant changes for heatmap
```{r significant changes for heatmap}
res_ttest_p_m <- melt(res_ttest_p[union_cultivar,])

# p < 0.01 **
# p < 0.001 ***
res_ttest_p_m$value3<-cut(res_ttest_p_m$value,
                   breaks=c(-Inf, 0.001, 0.01),
                   label=c("***", "**")) 

signif2 <- matrix(res_ttest_p_m$value3, ncol=4)
```


# Heatmap
```{r heatmap}
mat_data <- as.matrix(values_norm_median_rev_t_log2FC[union_cultivar,])

distance = dist(mat_data, method = "euclidian")
cluster = hclust(distance, method = "average")

#mycluster <- cutree(cluster, h=max(cluster$height)/1.5)
mycluster <- cutree(cluster, k=4)
mycluster[cluster$order]

mycolor <- brewer.pal(8, "Set2")
mycolor <- mycolor[as.vector(mycluster)]

my_palette <- colorRampPalette(c("blue", "white", "red"))(n = 299)

col_breaks = c(seq(-1,-0.3,length=100), # for blue
               seq(-0.3,0.3,length=100), # for white
               seq(0.3,2,length=100)) # for red

#pdf("../../Doktorarbeit/figures/heatmap_log2FC_signif_cultivars_field_new.pdf", width=6.5, height=10)
#pdf("../heatmaps/merge_field_experiments_late/heatmap_log2FC_signif.pdf", width=6, height=10)

lmat=rbind(4:3, 2:1)
lhei=c(0.8, 4)
lwid=c(1, 4)

layout(mat = lmat, widths = lwid, heights = lhei)

heatmap.2(mat_data,
  cellnote = signif2,  # same data set for cell labels
  notecex=1.5, # numeric scaling factor for cellnote items
  colsep=1:ncol(mat_data), 
  rowsep=1:nrow(mat_data),
  sepwidth=c(0.01,0.05),
  sepcolor="black",
  main = "", # heat map title
  notecol="black",      # change font color of cell labels to black
  density.info="none",  # turns off density plot inside color legend
  trace="none",         # turns off trace lines inside the heat map
  margins =c(6,20),     # widens margins around plot
  keysize=1.5,
  cexRow=1.5,
  cexCol=1.5,
  lhei=c(0.6, 4),
  col=my_palette,       # use on color palette defined earlier 
  breaks=col_breaks,    # enable color transition at specified limits
  RowSideColors=mycolor,
  Rowv=as.dendrogram(cluster),
  dendrogram="row",     # only draw a row dendrogram
  Colv="NA")            # turn off column clustering```

#dev.off()
```


```{r heatmap REORDERED}
mat_data <- as.matrix(values_norm_median_rev_t_log2FC[union_cultivar,])

distance <- dist(mat_data, method = "euclidian")
cluster <- hclust(distance, method = "average")

cluster2 <- dendsort(cluster, type = "average") 

#mycluster <- cutree(cluster, h=max(cluster$height)/1.5)
mycluster <- cutree(cluster2, k=4)
mycluster[cluster2$order]

mycolor <- brewer.pal(8, "Set2")
mycolor <- mycolor[as.vector(mycluster)]

my_palette <- colorRampPalette(c("blue", "white", "red"))(n = 299)

# col_breaks = c(seq(-1,-0.3,length=100), # for blue
#                seq(-0.3,0.3,length=100), # for white
#                seq(0.3,2,length=100)) # for red

col_breaks = c(seq(-2,-0.3,length=100), # for blue
               seq(-0.3,0.3,length=100), # for white
               seq(0.3,2,length=100)) # for red

# for Phd-thesis: cultivar effect, with treatment as symbol
pdf("../../TROST/Manuskripte/tba/heatmap_log2FC_signif_cultivars_field_reordered_average_new_scale2.pdf", width=6, height=10)
#pdf("../heatmaps/merge_pot_experiments/heatmap_log2FC_signif.pdf", width=6, height=10)

lmat=rbind(4:3, 2:1)
lhei=c(0.8, 4)
lwid=c(1, 4)

layout(mat = lmat, widths = lwid, heights = lhei)

heatmap.2(mat_data,
  cellnote = signif2,  # same data set for cell labels
  notecex=1.5, # numeric scaling factor for cellnote items
  colsep=1:ncol(mat_data), 
  rowsep=1:nrow(mat_data),
  sepwidth=c(0.01,0.05),
  sepcolor="black",
  main = "", # heat map title
  notecol="black",      # change font color of cell labels to black
  density.info="none",  # turns off density plot inside color legend
  trace="none",         # turns off trace lines inside the heat map
  margins =c(6,20),     # widens margins around plot
  keysize=1.5,
  cexRow=1.5,
  cexCol=1.5,
  lhei=c(0.6, 4),
  col=my_palette,       # use on color palette defined earlier 
  breaks=col_breaks,    # enable color transition at specified limits
  RowSideColors=mycolor,
  Rowv=as.dendrogram(cluster2),
  dendrogram="row",     # only draw a row dendrogram
  Colv="NA")           # turn off column clustering```

dev.off()
```


### export tables that contain only sig changed analytes (treatment effect)
```{r export tables that contain only sig changed analytes}
# only significantly changed analytes

# 58 metabolites that changed either per cultivar or across all samples in t-test (control vs stress)
write.table(values_norm_median_rev_t_log2FC[-not_sig,], 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_t_log2FC_for_heatmap_sig.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)

# only 36 metabolites that changed per cultivar!
write.table(values_norm_median_rev_t_log2FC[union_cultivar,], 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_t_log2FC_for_heatmap_sig_per_cul.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)

#########################

write.table(values_norm_median_rev_transformed[-not_sig,], 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_transformed_for_heatmap_sig.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


### export of tables for heatmap
```{r export of tables for heatmap}
# export only rows with significant results of ANOVA for cultivar
write.table(values_norm_median_rev_transformed[res_anova_treatment_cultivar_sig_cul,], 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_transformed_for_heatmap_cul.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)

# export only rows with significant results of ANOVA for cultivar AND treatment
write.table(values_norm_median_rev_transformed[res_anova_treatment_cultivar_sig_both,], 
            "output/merge_field_experiments_late/values_norm_log10_median_rev_transformed_for_heatmap_both.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Venn diagramm control vs. stress
```{r venn diagramm control vs. stress}
w=list(
  "Alegria \n (19)" = which(res_ttest_alegria<0.01),
  "Desiree \n (19)" = which(res_ttest_desiree<0.01),
  "Milva \n (24)" = which(res_ttest_milva<0.01),
  "Saturna \n (22)" = which(res_ttest_saturna<0.01))

venn.plot <- venn.diagram(
  x = w,  filename = "figures/merge_field_experiments_late/venn_control_stress_cultivars.png",
  col = "black",
  fill = c("goldenrod1", "dodgerblue2", "darkorange2", "cyan3"), #category colors  
  alpha = 0.5,
  cat.cex = 1.5, #cat font size
  cat.fontface = "bold",
  margin = 0.05, # Bildbegrenzung 
  cex = 1.5, 
  cat.dist = 0.25, 
  scaled = FALSE)

#grid.draw(venn.plot)
```


## Venn diagram control vs. stress (all 4 time points)
### UP
```{r venn diagram control vs. stress UP}
w=list(
  "Alegria \n (13)" = intersect(which(log2FC_up_down_alegria == "up"), which(res_ttest_alegria<0.01)),
  "Desiree \n (12)" = intersect(which(log2FC_up_down_desiree == "up"), which(res_ttest_desiree<0.01)),
  "Milva \n (14)" = intersect(which(log2FC_up_down_milva == "up"), which(res_ttest_milva<0.01)),
  "Saturna \n (11)" = intersect(which(log2FC_up_down_saturna == "up"), which(res_ttest_saturna<0.01))
  )

venn.plot <- venn.diagram(
  x = w,  filename = "figures/merge_field_experiments_late/venn_control_stress_cultivars_up.png",
  col = "black",
  fill = c("goldenrod1", "dodgerblue2", "darkorange2", "cyan3"), #category colors  
  alpha = 0.5,
  cat.cex = 1.5, #cat font size
  cat.fontface = "bold",
  margin = 0.05, # Bildbegrenzung
  cex=1.5, 
  cat.dist=0.25, 
  scaled=FALSE)
```


### DOWN
```{r venn diagram control vs. stress DOWN}
w=list(
  "Alegria \n (11)" = intersect(which(log2FC_up_down_alegria == "down"), which(res_ttest_alegria<0.01)),
  "Desiree \n (7)" = intersect(which(log2FC_up_down_desiree == "down"), which(res_ttest_desiree<0.01)),
  "Milva \n (10)" = intersect(which(log2FC_up_down_milva == "down"), which(res_ttest_milva<0.01)),
  "Saturna \n (11)" = intersect(which(log2FC_up_down_saturna == "down"), which(res_ttest_saturna<0.01))
  )

venn.plot <- venn.diagram(
  x = w,  filename = "figures/merge_field_experiments_late/venn_control_stress_cultivars_down.png",
  col = "black",
  fill = c("goldenrod1", "dodgerblue2", "darkorange2", "cyan3"), #category colors  
  alpha = 0.5,
  cat.cex = 1.5, #cat font size
  cat.fontface = "bold",
  margin = 0.05, # Bildbegrenzung 
  cex=1.5, 
  cat.dist=0.25, 
  scaled=FALSE)
```


# Control vs. stress separately for tolerant and sensitive
```{r t-test control vs. stress for tolerant/sensitive samples}
res_ttest_tolerant <- func_ttest_treatment(values_norm, factors, fac1 = "tolerance", val1 = "tolerant", 0.01)
res_ttest_sensitive <- func_ttest_treatment(values_norm, factors, fac1 = "tolerance", val1 = "sensitive", 0.01)

# OVERLAP between tolerant and sensitive (control vs. stress)
intersect_tolerance <- intersect(which(res_ttest_tolerant<0.01), which(res_ttest_sensitive<0.01))
length(intersect_tolerance)
# 23

# union across all cultivars
union_tolerance <- sort(union(which(res_ttest_tolerant<0.01), which(res_ttest_sensitive<0.01)))
length(union_tolerance)
# 42

res_ttest_p_tolerance <- cbind(p_sensitive = res_ttest_sensitive, p_tolerant = res_ttest_tolerant)

write.table(union_tolerance, "output/merge_field_experiments_late/union_tolerance.txt", sep="\t")
write.table(res_ttest_p_tolerance, "output/merge_field_experiments_late/res_ttest_p_tolerance.txt", sep="\t")
```


# Calculate log2FC: up or down regulated
** use log10 reverse transformed values for log2FC calculation **
```{r calculate log2FC tolerant/sensitive}
# per tolerance group
log2FC_tolerant <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "tolerance", fac1_val = "tolerant",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")

log2FC_sensitive <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "tolerance", fac1_val = "sensitive",
                                   fac2 = "treatment", fac2_val1 = "control", fac2_val2 = "drought stress")
```


## Up or down regulated analytes
```{r up or down regulated tolerant/sensitive}
# get a factor with the value up or down for all analytes
log2FC_up_down_tolerant <- func_log2FC_up_down(log2FC_tolerant)
log2FC_up_down_sensitive <- func_log2FC_up_down(log2FC_sensitive)

# get a list with ALL analytes that are up or down
log2FC_dir_tolerant <- func_log2FC_dir(log2FC_tolerant)
log2FC_dir_sensitive <- func_log2FC_dir(log2FC_sensitive)

# get a list with significantly changed analytes that are up or down
log2FC_dir_sig_tolerant <- func_log2FC_dir_sig(log2FC_dir_tolerant, res_ttest_tolerant, 0.01)
log2FC_dir_sig_sensitive <- func_log2FC_dir_sig(log2FC_dir_sensitive, res_ttest_sensitive, 0.01)
```


## Compare lists of up/down regulated analytes
```{r compare lists of up/down regulated analytes tolerant/sensitive}
# compare tolerant and sensitive
# UP
func_compare_2lists_up(log2FC_dir_sig_tolerant, log2FC_dir_sig_sensitive)
# DOWN
func_compare_2lists_down(log2FC_dir_sig_tolerant, log2FC_dir_sig_sensitive)
```


## Aggregate normalized values for heatmap tolerant/sensitive
```{r aggregate normalized values tolerant/sensitive}
source("../../functions/func_aggregate_values.R")

# for matrix with NAs using 2 factors (treatment, cultivar)
# MEDIAN
values_norm_median_tol <- func_agg_2fac(values_norm, factors, "tolerance", "treatment", 
                                              median, analytes_sel_exp_sort)
dim(values_norm_median_tol)
# 4 samples (rows), 108 (1 sampleID, 107 analytes, columns)

# export TRANSPOSED matrix for heatmap
values_norm_median_tol_t <- t(values_norm_median_tol[,-1])
colnames(values_norm_median_tol_t) <- values_norm_median_tol$sample
dim(values_norm_median_tol_t)
# 107 analytes (rows), 4 samples (columns)

#  write.table(values_norm_median_tol_t, 
#              "output/merge_field_experiments_late/values_norm_log10_late_before_median_tol_for_heatmap.txt", 
#              sep = "\t", quote = F, col.names = NA, row.names = T)
```


## Reverse log-transformation
```{r reverse log-transformation}
values_norm_median_tol_rev <- 10^(values_norm_median_tol[,-1]) # without sample names
dim(values_norm_median_tol_rev)
# 4 samples (rows), 107 analytes (columns)

## samples are in rows, analytes in columns
## for transformation: samples should be in columns and analytes in rows --> row-wise median is median over all samples of 1 analyte

values_norm_median_tol_rev_t <- t(values_norm_median_tol_rev)
dim(values_norm_median_tol_rev_t)
# 107 analytes (rows), 4 samples (columns)
colnames(values_norm_median_tol_rev_t) <- values_norm_median_tol$sample
```


## Calculation of log-median-ratio
```{r calculation of log-median-ratio}
# source("../../functions/func_log_transform.R")

# values_norm_log10_late_before_median_tol_rev_transformed <- log_transform(values_norm_log10_late_before_median_tol_rev_t)
# dim(values_norm_log10_late_before_median_tol_rev_transformed)
# # 107 analytes, 8 samples
# 
# # export matrix for heatmap
# write.table(values_norm_log10_late_before_median_tol_rev_transformed, 
#             "../output/merge_pot_experiments/values_norm_log10_late_before_median_tolerance_rev_transformed_for_heatmap.txt", 
#             sep = "\t", quote = F, col.names = NA, row.names = T)
```


### calculation of log2-fold-change
```{r calculation of log2-fold-change}
colnames(values_norm_log10_median_tol_rev_t)

# use function:
source("../../functions/func_log2_fold_change.R")

values_norm_log10_median_tol_rev_t_log2FC <- log2_fold_change(values_norm_log10_median_tol_rev_t)
dim(values_norm_log10_median_tol_rev_t_log2FC)
range(values_norm_log10_median_tol_rev_t_log2FC, na.rm=TRUE)

# change colnames ("trial", "cultivar", "sample_time")
colnames(values_norm_log10_median_tol_rev_t_log2FC) <- levels(factors$tolerance)

# export matrix for heatmap
write.table(values_norm_log10_median_tol_rev_t_log2FC, 
              "../output/merge_field_experiments_late/values_norm_log10_median_tol_rev_t_log2FC_for_heatmap.txt", 
              sep = "\t", quote = F, col.names = NA, row.names = T)
```



### significant changes for heatmap
```{r significant changes for heatmap tolerant/sensitive}
library(reshape)
res_ttest_p_tolerance_m <- melt(res_ttest_p_tolerance[union_tolerance,])

# p < 0.01 **
# p < 0.001 ***
res_ttest_p_tolerance_m$value2<-cut(res_ttest_p_tolerance_m$value,
                   breaks=c(-Inf, 0.001, 0.01),
                   label=c("***", "** ")) 

signif_tolerance <- matrix(res_ttest_p_tolerance_m$value2, ncol=2)
write.table(signif_tolerance, "../output/merge_field_experiments_late/signif_tolerance.txt", sep="\t")
```


### heatmap
```{r heatmap tolerant/sensitive}
library(gplots)

mat_data_tolerance <- as.matrix(values_norm_log10_median_tol_rev_t_log2FC[union_tolerance,])
write.table(mat_data_tolerance, "../output/merge_field_experiments_late/mat_data_tolerance.txt", sep="\t")

distance_tolerance = dist(mat_data_tolerance, method = "euclidian")
cluster_tolerance = hclust(distance_tolerance, method = "average")

#mycluster <- cutree(cluster, h=max(cluster$height)/1.5)
mycluster_tolerance <- cutree(cluster_tolerance, k=4)
mycluster_tolerance[cluster_tolerance$order]

mycolor <- brewer.pal(8, "Set2")
mycolor <- mycolor[as.vector(mycluster_tolerance)]

my_palette <- colorRampPalette(c("blue", "white", "red"))(n = 299)

col_breaks = c(seq(-1.5,-0.3,length=100), # for blue
               seq(-0.3,0.3,length=100), # for white
               seq(0.3,1.5,length=100)) # for red

pdf("../heatmaps/merge_field_experiments_late/heatmap_log2FC_signif_tol.pdf", width=6, height=10)

lmat=rbind(4:3, 2:1)
lhei=c(0.8, 4)
lwid=c(1, 4)

layout(mat = lmat, widths = lwid, heights = lhei)

heatmap.2(mat_data_tolerance,
  cellnote = signif_tolerance,  # same data set for cell labels
  notecex=1.5, # numeric scaling factor for cellnote items
  colsep=1:ncol(mat_data_tolerance), 
  rowsep=1:nrow(mat_data_tolerance),
  sepwidth=c(0.01,0.05),
  sepcolor="black",
  main = "", # heat map title
  notecol="black",      # change font color of cell labels to black
  density.info="none",  # turns off density plot inside color legend
  trace="none",         # turns off trace lines inside the heat map
  margins =c(6,22),     # widens margins around plot
  keysize=1.8,
  cexRow=1.5,
  cexCol=1.5,
  lhei=c(0.6, 4),
  col=my_palette,       # use on color palette defined earlier 
  breaks=col_breaks,    # enable color transition at specified limits
  RowSideColors=mycolor,
  Rowv=as.dendrogram(cluster_tolerance),
  dendrogram="row",     # only draw a row dendrogram
  Colv="NA")            # turn off column clustering```

dev.off()
```









#### tolerant vs. sensitive separately for control and stress samples
```{r t-test tolerant vs. sensitive}
res_ttest_tolerance_control <- func_ttest_treatment(values_norm_log10, factors, 
                                                    fac1 = "treatment", val1 = "control", 0.01, 
                                                    contrast_fac = "tolerance", contrast_val1 = "tolerant", contrast_val2 = "sensitive")

res_ttest_tolerance_stress <- func_ttest_treatment(values_norm_log10, factors, 
                                                    fac1 = "treatment", val1 = "drought stress", 0.01, 
                                                    contrast_fac = "tolerance", contrast_val1 = "tolerant", contrast_val2 = "sensitive")

# OVERLAP between tolerant and sensitive (control vs. stress)
intersect_tolerance_treatment <- intersect(which(res_ttest_tolerance_control<0.01), which(res_ttest_tolerance_stress<0.01))
length(intersect_tolerance_treatment)
# 19
```


#### log2FC: up or down regulated
** use log10 reverse transformed values for log2FC calculation **
```{r calculate log2FC tolerant vs. sensitive}
source("../../functions/func_log2FC_ttest.R")

# per tolerance group
log2FC_tolerance_control <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "treatment", fac1_val = "control",
                                   fac2 = "tolerance", fac2_val1 = "tolerant", fac2_val2 = "sensitive")

log2FC_tolerance_stress <- func_log2FC_2fac(values_norm_rev, factors, average_func = median,
                                   fac1 = "treatment", fac1_val = "drought stress",
                                   fac2 = "tolerance", fac2_val1 = "tolerant", fac2_val2 = "sensitive")
```

#### up or down regulated
```{r up or down regulated tolerant vs. sensitive}

# UP means higher in sensitive than in tolerant
# DOWN means lower in sensitive than in tolerant

# get a factor with the value up or down for all analytes
log2FC_up_down_tolerance_control <- func_log2FC_up_down(log2FC_tolerance_control)
log2FC_up_down_tolerance_stress <- func_log2FC_up_down(log2FC_tolerance_stress)

# get a list with ALL analytes that are up or down
log2FC_dir_tolerance_control <- func_log2FC_dir(log2FC_tolerance_control)
log2FC_dir_tolerance_stress <- func_log2FC_dir(log2FC_tolerance_stress)

# get a list with significantly changed analytes that are up or down
log2FC_dir_sig_tolerance_control <- func_log2FC_dir_sig(log2FC_dir_tolerance_control, res_ttest_tolerance_control, 0.01)
log2FC_dir_sig_tolerance_stress <- func_log2FC_dir_sig(log2FC_dir_tolerance_stress, res_ttest_tolerance_stress, 0.01)
```


```{r affected metabolites}
analytes_sel_exp_sort$name_short[log2FC_dir_sig_tolerance_control$up]
analytes_sel_exp_sort$name_short[log2FC_dir_sig_tolerance_control$down]

analytes_sel_exp_sort$name_short[log2FC_dir_sig_tolerance_stress$up]
analytes_sel_exp_sort$name_short[log2FC_dir_sig_tolerance_stress$down]

```



```{r boxplot tolerance * treatment arbutin}
source("../functions/func_boxplot.R")

# treatment * tolerance
names_treatment_tolerance <- c("control \n sensitive", "drought \n sensitive", "control \n tolerant", "drought \n tolerant")

# for Phd-thesis: cultivar effect, with treatment as symbol
pdf("../../../../Doktorarbeit/figures/boxplot_tolerance_treatment_arbutin_field.pdf", width=6, height=6)
#pdf("../figures/merge_field_experiments_late/boxplot_tolerance_treatment_arbutin.pdf")
par(mar=c(4, 4.5, 2, 0.5))

func_boxplot_2fac_single(normalized_values = values_norm_log10, 
                  trial_factors = factors, factor1 = "treatment", factor2 = "tolerance", 
                  cols = cols_treatment_sample_time, names_factors = names_treatment_tolerance,
                  analytes_sel_exp_sort, "Arbutin", "arbutin (field)", x.axis="n")

axis(1, at=1:4 , labels=names_treatment_tolerance, padj=0.5, cex.axis=1.35)

# legend("bottomright", cex=1, bty="n", fill=cols_treatment_sample_time, legend = c("control sensitive", "drought sensitive", "control tolerant", "drought tolerant"))

dev.off()
```



### calculation of log-median-ratio ONLY FOR CONTROL
```{r calculation of log-median-ratio ONLY FOR CONTROL}
# first log_ratio, then median
values_norm_log10_control_rev <- 10^(values_norm_log10_control)
values_norm_log10_control_rev_t <- t(values_norm_log10_control_rev)
values_norm_log10_control_rev_t_transformed <- log_transform(values_norm_log10_control_rev_t)
dim(values_norm_log10_control_rev_t_transformed)
# 107 72
values_norm_log10_control_rev_t_transformed <- as.matrix(values_norm_log10_control_rev_t_transformed)

# calculate median per cultivar (only control)
source("../../functions/func_aggregate_values.R")
values_norm_log10_control_rev_t_transformed_median <- func_agg_1fac(t(values_norm_log10_control_rev_t_transformed), 
                                                                    factors_control, "cultivar", median, analytes_sel_exp_sort)
dim(values_norm_log10_control_rev_t_transformed_median)
# 4 samples (rows), 108 (1 sampleID, 107 analytes, columns)

# export TRANSPOSED matrix for heatmap
values_norm_log10_control_rev_t_transformed_median_t <- t(values_norm_log10_control_rev_t_transformed_median[,-1])
colnames(values_norm_log10_control_rev_t_transformed_median_t) <- values_norm_log10_control_rev_t_transformed_median$sample
dim(values_norm_log10_control_rev_t_transformed_median_t)
# 107 analytes (rows), 4 samples (columns)

# export matrix for heatmap, only significant results of cultivar-effect in ANOVA with control samples
write.table(values_norm_log10_control_rev_t_transformed_median_t[res_anova_control_cultivar_sig,], 
            "../heatmaps/merge_field_experiments_late/values_norm_log10_control_rev_transformed_median_for_heatmap_sig.txt", 
            sep = "\t", quote = F, col.names = NA, row.names = T)
```


# Correlation analysis
```{r correlation analysis}
values_norm_renamed <- values_norm
colnames(values_norm_renamed) <- analytes_sel_exp_sort$Name

res_cor <- cor(values_norm_renamed, method = "pearson", use = "pairwise.complete.obs")

heatmap.2(res_cor, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"),
          hclustfun = function(x) hclust(x,method = 'complete'))

heatmap.2(res_cor, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"),
          hclustfun = function(x) hclust(x,method = 'average'))
```

```{r correlation control/drought stress}
# only control samples
values_norm_control <- subset(values_norm_renamed, factors$treatment == "control")
# only drought stress samples
values_norm_drought <- subset(values_norm_renamed, factors$treatment == "drought stress")

res_cor_control <- cor(values_norm_control, method = "pearson", use = "pairwise.complete.obs")
res_cor_drought <- cor(values_norm_drought, method = "pearson", use = "pairwise.complete.obs")

pdf("figures/merge_field_experiments_late/heatmap_cor_control.pdf", 9, 9)
heatmap.2(res_cor_control, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5)
heatmap.2(res_cor_control, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5, 
          hclustfun = function(x) hclust(x,method = 'average'))
dev.off()
pdf("figures/merge_field_experiments_late/heatmap_cor_drought_stress.pdf", 9, 9)
heatmap.2(res_cor_drought, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"),  cexRow = 0.5, cex = 0.5)
heatmap.2(res_cor_drought, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5, 
          hclustfun = function(x) hclust(x,method = 'average'))
dev.off()

hist(res_cor_control, col="grey", breaks=50)
hist(res_cor_drought, col="grey", breaks=50)

res_treatment <- data.frame(cor_val = as.vector(res_cor_control),
                       treatment = rep("control", length(as.vector(res_cor_control))))

res_drought <- data.frame(cor_val = as.vector(res_cor_drought),
                       treatment = rep("drought", length(as.vector(res_cor_drought))))

res_treatment <- rbind(res_treatment, res_drought)
library(sm)
sm.density.compare(res_treatment$cor_val, res_treatment$treatment)

mean(res_cor_control)
mean(res_cor_drought)
```


```{r correlation sensitive/tolerant}
# only sensitive samples
values_norm_sensitive <- subset(values_norm_renamed, factors$tolerance == "sensitive")
# only tolerant stress samples
values_norm_tolerant <- subset(values_norm_renamed, factors$tolerance == "tolerant")

res_cor_sensitive <- cor(values_norm_sensitive, method = "pearson", use = "pairwise.complete.obs")
res_cor_tolerant <- cor(values_norm_tolerant, method = "pearson", use = "pairwise.complete.obs")

pdf("figures/merge_field_experiments_late/heatmap_cor_sensitive.pdf", 9, 9)
heatmap.2(res_cor_sensitive, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5)
heatmap.2(res_cor_sensitive, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5, 
          hclustfun = function(x) hclust(x,method = 'average'))
dev.off()
pdf("figures/merge_field_experiments_late/heatmap_cor_tolerant.pdf", 9, 9)
heatmap.2(res_cor_tolerant, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cexCol = 0.5)
heatmap.2(res_cor_tolerant, trace = "none", density.info = "none", col = brewer.pal(11,"Spectral"), cexRow = 0.5, cex = 0.5, 
          hclustfun = function(x) hclust(x,method = 'average'))
dev.off()

hist(res_cor_sensitive, col="grey", breaks=50)
hist(res_cor_tolerant, col="grey", breaks=50)

res_tolerance <- data.frame(cor_val = as.vector(res_cor_tolerant),
                       tolerance = rep("tolerant", length(as.vector(res_cor_tolerant))))

res_sensitive <- data.frame(cor_val = as.vector(res_cor_sensitive),
                       tolerance = rep("sensitive", length(as.vector(res_cor_sensitive))))

res_tolerance <- rbind(res_tolerance, res_sensitive)
library(sm)
sm.density.compare(res_tolerance$cor_val, res_tolerance$tolerance)

mean(res_cor_sensitive)
mean(res_cor_tolerant)
```

## correlation with corrplot
```{r correlation with corrplot}
corr_test_values_norm <- corr.test(values_norm_renamed, adjust="BH")
dim(corr_test_values_norm$p)

write.table(corr_test_values_norm$r, "output/merge_field_experiments_late/corr_test_values_norm_r.txt", sep="\t")
write.table(corr_test_values_norm$p, "output/merge_field_experiments_late/corr_test_values_norm_p.txt", sep="\t")

pdf("figures/merge_field_experiments_late/corrplot_all_data_average_linkage.pdf",10,10)
corrplot(corr_test_values_norm$r, method="color", order="hclust", hclust.method="average", tl.col="black", tl.cex=0.5)
dev.off()

pdf("figures/merge_field_experiments_late/corrplot_all_data_complete_linkage.pdf",10,10)
corrplot(corr_test_values_norm$r, method="color", order="hclust", hclust.method="complete", tl.col="black", tl.cex=0.5)
dev.off()

# sensitive/tolerant
corr_test_values_norm_sens <- corr.test(values_norm_sensitive, adjust="BH")
corr_test_values_norm_tol <- corr.test(values_norm_tolerant, adjust="BH")

pdf("figures/merge_field_experiments_late/corrplot_sensitive.pdf",10,10)
corrplot(corr_test_values_norm_sens$r, method="color", order="hclust", hclust.method="average", tl.col="black", tl.cex=0.5)
corrplot(corr_test_values_norm_sens$r, method="color", order="hclust", hclust.method="complete", tl.col="black", tl.cex=0.5)
dev.off()

pdf("figures/merge_field_experiments_late/corrplot_tolerant.pdf",10,10)
corrplot(corr_test_values_norm_tol$r, method="color", order="hclust", hclust.method="average", tl.col="black", tl.cex=0.5)
corrplot(corr_test_values_norm_tol$r, method="color", order="hclust", hclust.method="complete", tl.col="black", tl.cex=0.5)
dev.off()
```


## create input for cytoscape
```{r create input for cytoscape}

func_create_cytoscape_input <- function(corr_mat, analytes_table, threshold = 0.6){
  x <- corr_mat
  diag(x) <- NA
  x[upper.tri(x)] <- NA
  x_melt <- melt(x)
  # remove NA (upper.tri and diag)
  x_melt_part <- x_melt[!is.na(x_melt$value),]
  colnames(x_melt_part) <- c("source", "target", "value")
  
  # merge table with analyte classes (column 4)
  x_melt_part2 <- merge(x_melt_part, analytes_sel_exp_sort[,3:4], by.x = "source", "Name")
  
  # filter results above specific threshold for correlation
  x_melt_filtered <- x_melt_part2[which(abs(x_melt_part2$value) > threshold),]
  
  return(x_melt_filtered)
}

res_cytoscape <- func_create_cytoscape_input(corr_test_values_norm$r, analytes_sel_exp_sort, threshold = 0.6)
res_cytoscape_sens <- func_create_cytoscape_input(corr_test_values_norm_sens$r, analytes_sel_exp_sort, threshold = 0.6)
res_cytoscape_tol <- func_create_cytoscape_input(corr_test_values_norm_tol$r, analytes_sel_exp_sort, threshold = 0.6)

write.table(res_cytoscape, "output/merge_field_experiments_late/cytoscape_input_all_samples.txt", sep = "\t", row.names = FALSE)
write.table(res_cytoscape_sens, "output/merge_field_experiments_late/cytoscape_input_sensitive.txt", sep = "\t", row.names = FALSE)
write.table(res_cytoscape_tol, "output/merge_field_experiments_late/cytoscape_input_tolerant.txt", sep = "\t", row.names = FALSE)
```



## sorted boxplots per cultivar
```{r sorted boxplots per cultivar}
pdf("figures/merge_field_experiments_late/boxplot_sorted_per_cultivar.pdf", 10, 6)
func_boxplot_sorted2(all_values_norm, all_factors$cultivar, analytes_sel_exp_sort)
dev.off()
```


## plot of A159003 and 174001
```{r plot of A159003 and 174001}
which(analytes_sel_exp_sort$analyteID == "A159003-101")
which(analytes_sel_exp_sort$analyteID == "A174001-101")

which(analytes_sel_exp_sort$Name == "Proline")
which(analytes_sel_exp_sort$Name == "Galactinol")

plot(values_norm[,34], values_norm[,100], col=factors$treatment)
plot(values_norm[,68], values_norm[,89], col=factors$treatment)
```



### Save workspace and sessionInfo
```{r save workspace}
save.image("merge_field_experiments_late.RData")
sessionInfo()
```

