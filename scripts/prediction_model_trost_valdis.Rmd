---
title: Prediction model with TROST and VALDIS data
author: "Heike Sprenger"
date: "March 6, 2016"
output:
  html_document:
    highlight: tango
    number_section: yes
    theme: cerulean
    toc: yes
    toc_depth: 4
---

# Set pander and knitr options
```{r set pander and knitr options, message=FALSE}
library(knitr)
library(pander)
library(randomForest)
# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width=5, fig.height=5, cache=FALSE, highlight = TRUE, fig.show="asis")
opts_knit$set(root.dir = '../')
```


# Load packages and functions for metabolite data analysis
```{r load packages and functions for metabolite data analysis, message=FALSE, fig.show='hide'}
# load packages
source("../functions/func_load_packages_metabolite_data_analysis.R")

# load functions
source("../functions/func_load_functions_metabolite_data_analysis.R")
```


# Paste file names with experiment_string
```{r paste file names with experiment_string, tidy=TRUE}
file_analytes_table <- paste("data/", analytes_table, ".txt", sep = "")
 
# file_gmd_values_select <- paste("output/", experiment_string, "/gmd_values_select.txt", sep = "")
# file_gmd_values_select_log10 <- paste("output/", experiment_string, "/gmd_values_select_log10.txt", sep = "")
# file_gmd_values_select_log10_woNA <- paste("output/", experiment_string, "/gmd_values_select_log10_woNA.txt", sep = "")
# 
# file_values_norm_log10_woOutlier <- paste("output/", experiment_string, "/values_norm_log10_woOutlier.txt", sep = "")
# file_gmd_values_select_log10_woOutlier <- paste("output/", experiment_string, "/gmd_values_select_log10_woOutlier.txt", sep = "")
```


# Set up database connection to GMD
```{r set up database connection to GMD}
login_gmd <- yaml.load_file("../functions/login_gmd.yaml")

if (.Platform$OS.type == 'windows'){
  dbhandle <- odbcDriverConnect('driver={SQL Server}; 
                                server=r710sqljahu; 
                                database=GMD; 
                                trusted_connection=true')
} else { # if .Platform$OS.type == 'unix'
  dbhandle <- odbcDriverConnect(
    connection=paste0("server=",login_gmd$host,
                      ";database=",login_gmd$db,
                      ";uid=",login_gmd$user,
                      ";pwd=",login_gmd$passwd,
                      ";Port=1433;driver=FreeTDS;TDS_Version=8.0;"))
}
```


# Load data
## Load phenotyper results
this table comes from ``phenotyper_metadata.Rmd``
```{r load phenotyper results}
phenotyper_result_joined <- read.table("data/phenotyper_result_joined_with_gmd_ids.txt", 
                                       sep="\t", header = T)
```


## Load analytes table
this table comes from ``gmd_analytes.Rmd``
```{r load analytes table}
analytes_sel_exp_sort <- read.table(file_analytes_table, sep ="\t", header = T, allowEscapes = T)
```


## Load `trost_TagList`
`trost_TagList` shows all experiments that belong to the TROST/VALDIS project and comes from `gmd_first_steps.Rmd`

```{r load trost taglist}
trost_TagList <- read.table("data/trost_TagList.txt", sep="\t", header=TRUE)

trost_gmd_ids <- read.table("data/trost_gmd_ids.txt", sep="\t", header=TRUE)
head(trost_gmd_ids)
```


## Load tables with GMD metadata
```{r load tables with GMD metadata}
# TROST
gmd_meta_mpi_field_2011 <- read.table("data/gmd_meta_mpi_field_2011.txt", sep = "\t", header = T)
gmd_meta_mpi_field_2012 <- read.table("data/gmd_meta_mpi_field_2012.txt", sep = "\t", header = T)
gmd_meta_jki_field_2012 <- read.table("data/gmd_meta_jki_field_2012.txt", sep = "\t", header = T)
gmd_meta_dethlingen_2011 <- read.table("data/gmd_meta_dethlingen_2011.txt", sep = "\t", header = T)
gmd_meta_jki_field_2013 <- read.table("../../TROST/GC-MS/GMD_Phenotyper/data/gmd_meta_jki_field_2013.txt", 
                                      sep = "\t", header = T)
gmd_meta_breeder_trials <- read.table("../../TROST/GC-MS/GMD_Phenotyper/data/gmd_meta_breeder_trials.txt", 
                                      sep = "\t", header = T)

colnames(gmd_meta_jki_field_2013) <- colnames(gmd_meta_breeder_trials) <- colnames(gmd_meta_jki_field_2012)

# VALDIS
gmd_meta_jki_shelter_2014 <- read.table("data/gmd_meta_jki_shelter_2014.txt", sep = "\t", header = T)
gmd_meta_jki_shelter_2015 <- read.table("data/gmd_meta_jki_shelter_2015.txt", sep = "\t", header = T)
gmd_meta_mpi_fgh_2014 <- read.table("data/gmd_meta_mpi_fgh_2014.txt", sep = "\t", header = T)
gmd_meta_mpi_fgh_2015 <- read.table("data/gmd_meta_mpi_fgh_2015.txt", sep = "\t", header = T)
gmd_meta_mpi_field_2015 <- read.table("data/gmd_meta_mpi_field_2015.txt", sep="\t", header = T)

#####################################

# exp_idx <- which(trost_TagList$experiment %in% experiment_names)
# trost_TagList_model <- droplevels(trost_TagList[exp_idx,])
# gmd_meta_per_exp_list <- vector("list", nrow(trost_TagList_model))
# for (i in trost_TagList_model$id){
#   gmd_meta_per_exp_list[[i]] <- func_get_gmd_metadata_3(i)
#   }
# gmd_meta_per_exp <- do.call(rbind, gmd_meta_per_exp_list)
# dim(gmd_meta_per_exp)
```


## Bind GMD metadata
```{r bind GMD metadata}
gmd_meta <- rbind(gmd_meta_mpi_field_2011, gmd_meta_mpi_field_2012, 
                  gmd_meta_jki_field_2012, gmd_meta_jki_field_2013,
                  gmd_meta_dethlingen_2011, gmd_meta_breeder_trials,
                  gmd_meta_jki_shelter_2014, gmd_meta_jki_shelter_2015,
                  gmd_meta_mpi_fgh_2014, gmd_meta_mpi_fgh_2015, gmd_meta_mpi_field_2015)

# change treatment
levels(gmd_meta$treatment)[4] <- levels(gmd_meta$treatment)[1] 

# change genotype names for cultivars
levels(gmd_meta$genotype_name)[1:34] <- names_cultivars_34

# use only control and stress treatments
gmd_meta_model <- droplevels(subset(gmd_meta, gmd_meta$treatment %in% c("Kontrolle", "Trockenstress")))
levels(gmd_meta_model$treatment) <- c("control", "drought stress")

# use only relevant genotypes (34 cultivars and 193 lines from 2014)
genotypes_model <- union(names_cultivars_34, names_lines_2014)
gmd_meta_model <- droplevels(subset(gmd_meta_model, gmd_meta_model$genotype_name %in% genotypes_model))

# use only late samples
gmd_meta_model <- droplevels(subset(gmd_meta_model, gmd_meta_model$sample_time == "late"))
dim(gmd_meta_model)
```


## Trial names
```{r trial names}
year <- rep("breeder_2011", nrow(gmd_meta_breeder_trials))
year[which(gmd_meta_breeder_trials$experiment_id %in% c("56876", "56878", "56879", 
                                                        "56880", "56881", "56882", 
                                                        "56883", "56884"))] = "breeder_2012"
year <- as.factor(year)
table(year)

mpi_feld_factors_trial <- as.factor(c(rep("mpi_feld_2011", 304),rep("mpi_feld_2012", 304)))
jki_feld_factors_trial <- as.factor(c(rep("jki_feld_2012", 136),rep("jki_feld_2013", 131)))
all_feld_factors_trial <- as.factor(c(rep("mpi_feld_2011", 304),rep("mpi_feld_2012", 304),
                                    rep("jki_feld_2012", 136),rep("jki_feld_2013", 131),
                                    rep("dethlingen_2011", 120)))

breeder_factors_trial <- gmd_meta_breeder_trials$experiment_name

valdis_factors_trial <- as.factor(c(rep("jki_shelter_2014", 384), rep("jki_shelter_2015", 252),
                                    rep("mpi_fgh_2014", 404), rep("mpi_fgh_2015", 254),
                                    rep("mpi_feld_2015", 377)))

trial <- as.factor(c(as.character(all_feld_factors_trial), 
                     as.character(breeder_factors_trial), 
                     as.character(valdis_factors_trial)))

trial_2 <- as.factor(c(as.character(all_feld_factors_trial), 
                       as.character(year), 
                       as.character(valdis_factors_trial)))
table(trial_2)

gmd_meta_model <- data.frame("trial" = trial, "trial_2" = trial_2, gmd_meta_model)

# sort table by chromatogram ID
gmd_meta_model_sort <- gmd_meta_model[order(as.character(gmd_meta_model$chromatogram)),]

# create column with genotype class (for VALDIS lines)
AxR <- which(grepl("^AR", gmd_meta_model$genotype_name))
ExA <- which(grepl("^EA", gmd_meta_model$genotype_name))
genotype_class <- as.character(gmd_meta_model$genotype_name)
genotype_class[AxR] <- "AxR"
genotype_class[ExA] <- "ExA"
gmd_meta_model$genotype_class <- factor(genotype_class)

# only the 995 samples from trost field trials
feld_idx <- which(gmd_meta_model_sort$trial %in% levels(all_feld_factors_trial))
feld_chrom <- droplevels(gmd_meta_model_sort$chromatogram[feld_idx])
length(feld_chrom)

gmd_meta_model_feld <- droplevels(gmd_meta_model_sort[feld_idx,])
table(gmd_meta_model_feld$trial_2)

# only the 1530 samples from trost field and breeder trials
trost_idx <- which(gmd_meta_model_sort$trial_2 %in% union(levels(all_feld_factors_trial), levels(year)))
trost_chrom <- droplevels(gmd_meta_model_sort$chromatogram[trost_idx])
length(trost_chrom)

gmd_meta_model_trost <- droplevels(gmd_meta_model_sort[trost_idx,])
table(gmd_meta_model_trost$trial_2)

write.table(gmd_meta_model, "output/gmd_meta_model.txt", sep="\t")
write.table(gmd_meta_model_sort, "output/gmd_meta_model_sort.txt", sep="\t")
write.table(gmd_meta_model_trost, "output/gmd_meta_model_trost.txt", sep="\t")

# valdis samples
valdis_idx <- which(gmd_meta_model_sort$trial %in% levels(valdis_factors_trial))
valdis_chrom <- droplevels(gmd_meta_model_sort$chromatogram[valdis_idx])
length(valdis_chrom)
```


## Load tables with GMD values
```{r Load tables with GMD values}
gmd_values <- read.table("data/gmd_raw_values_matrix.txt", sep = "\t", header = T, check.names = F)
dim(gmd_values)
```


# Define subset of selected chromatograms 
```{r subset of chromatograms}
# select real biological samples
gmd_values_model <- subset(gmd_values, rownames(gmd_values) %in% gmd_meta_model$chromatogram)
```


## Remove outlier, see chunk XXX: find outlier
```{r remove outlier, see chunk XXX: find outlier}
# which(rownames(gmd_values_model)=="098BC4DF-28D8-4966-A089-E6F2B0405EDF")
# # 23
# gmd_values_part <- gmd_values_part[-23,]
# 
# which(gmd_meta$chromatogram =="098BC4DF-28D8-4966-A089-E6F2B0405EDF")
# # 23
# gmd_meta <- gmd_meta[-23,]
```


# Define subset of overlapping analytes
## SELECT: `r nrow(analytes_sel_exp_sort)` overlapping analytes regarding ALL TROST and VALDIS experiments, WITHOUT internal standards and contaminations
```{r subset of analytes}
gmd_values_select <- func_get_overlapping_analytes(analytes_sel_exp_sort, gmd_values_model)
dim(gmd_values_select)

# the first 1530 lines contain only TROST samples 
gmd_values_select_trost <- gmd_values_select[trost_idx, ]
dim(gmd_values_select_trost)
head(rownames(gmd_values_select_trost))

write.table(gmd_values_select, "output/gmd_values_prediction_model.txt", sep="\t")
write.table(gmd_values_select_trost, "output/gmd_values_trost_prediction_model.txt", sep="\t")
```


# Replace NAs with minimal values of dataset and calculate LOG10 of raw intensity values 
```{r replace NAs and calc LOG10 of raw values}
# log10 transformation (with NAs)
gmd_values_select_log10 <- log10(gmd_values_select)
gmd_values_select_trost_log10 <- log10(gmd_values_select_trost)

# replace NAs with lowest value of dataset
gmd_values_select_woNA <- func_replace_na_with_min_value(gmd_values_select)
gmd_values_select_trost_woNA <- func_replace_na_with_min_value(gmd_values_select_trost)

# log10 transformation after NA replacement -> without NAs 
gmd_values_select_log10_woNA <- log10(gmd_values_select_woNA)
gmd_values_select_trost_log10_woNA <- log10(gmd_values_select_trost_woNA)

sum(is.na(gmd_values_select_log10))
sum(is.na(gmd_values_select_log10_woNA))

# all
write.table(gmd_values_select_log10, "output/gmd_values_prediction_model_log10.txt", sep="\t")
write.table(gmd_values_select_log10_woNA, "output/gmd_values_prediction_model_log10_woNA.txt", sep="\t")
# trost
write.table(gmd_values_select_trost_log10, "output/gmd_values_prediction_model_trost_log10.txt", sep="\t")
write.table(gmd_values_select_trost_log10_woNA, "output/gmd_values_prediction_model_trost_log10_woNA.txt", sep="\t")
```


# Extract Batch and SequenceID
```{r Extract Batch and SequenceID}
gmd_meta_model_trost$BatchID <- func_get_batch_ids(gmd_meta_model_trost)
gmd_meta_model_trost$SequenceID <- func_get_sequence_ids(gmd_meta_model_trost)
gmd_meta_model_trost$log10_AvgAnnotated <- log10(gmd_meta_model_trost$AvgAnnotated)

gmd_meta_model_sort$BatchID <- func_get_batch_ids(gmd_meta_model_sort)
gmd_meta_model_sort$SequenceID <- func_get_sequence_ids(gmd_meta_model_sort)
gmd_meta_model_sort$log10_AvgAnnotated <- log10(gmd_meta_model_sort$AvgAnnotated)
```


# Relevel factors and create factors table
```{r relevel factors and create factors table}
# define tolerance factor
tolerance <- func_create_tolerance_factor(gmd_meta_model_sort)
tolerance_trost <- func_create_tolerance_factor(gmd_meta_model_trost)

# create factors table for treatment, cultivar, sample_time, Dw, Fw, Is, AvgAnnotated, AvgAnnotatedLog10, BatchID, SequenceID
factors <- func_create_factors_table(gmd_meta_model_sort, 
                                     gmd_meta_model_sort$SequenceID, 
                                     gmd_meta_model_sort$BatchID, 
                                     tolerance)
levels(factors$genotype_class)

factors_trost <- func_create_factors_table(gmd_meta_model_trost, 
                                     gmd_meta_model_trost$SequenceID, 
                                     gmd_meta_model_trost$BatchID, 
                                     tolerance_trost)

write.table(factors, "output/factors_prediction_model.txt", sep="\t")
write.table(factors_trost, "output/factors_prediction_model_trost.txt", sep="\t")
```


# ANOVA normalization
```{r ANOVA normalization}
# all TROST + VALDIS trials, with/without NA
# gmd_values_select_log10
# gmd_values_select_log10_woNA

dim(gmd_values_select_log10)

norm_values_log10_woNA <- apply(gmd_values_select_log10_woNA, 2, RemoveFactors, sam = factors, 
                              facs = c("genotype_class", "treatment", "SequenceID", "BatchID", "log10_AvgAnnotated"), 
                              keep = c("genotype_class", "treatment"))

# equivalent to all_valdis_merge_IIIc
norm_values_log10 <- apply(gmd_values_select_log10, 2, RemoveFactors, sam = factors, 
                              facs = c("genotype_class", "treatment", "SequenceID", "BatchID", "log10_AvgAnnotated"), 
                              keep = c("genotype_class", "treatment"))

sum(is.na(norm_values_log10)) / (ncol(norm_values_log10) * nrow(norm_values_log10))*100
# 4.8%

write.table(norm_values_log10_woNA, "output/norm_values_log10_woNA_predicion_model.txt", sep="\t")
write.table(norm_values_log10, "output/norm_values_log10_prediction_model.txt", sep="\t")
```


# PCA
```{r PCA}
# only TROST
gmd_values_select_trost_prep <- prep(gmd_values_select_trost, scale = "none", center = F)

gmd_values_select_trost_prep_rnipals <- pca(gmd_values_select_trost_prep, nPcs = 5, method="rnipals")

pairs(gmd_values_select_trost_prep_rnipals@scores, col = gmd_meta_model_trost$trial_2)

#############################

# all TROST + VALDIS trials
gmd_values_log10_prep <- prep(gmd_values_select_log10, scale = "none", center = FALSE) # before normalization
norm_values_log10_prep <- prep(norm_values_log10, scale = "none", center = FALSE) # after normalization (with NA)
#all_valdis_merge_IIIc_woNA_none <- prep(all_valdis_merge_IIIc_woNA, scale = "none", center = FALSE) # after normalization

gmd_values_log10_prep_rnipals <- pca(gmd_values_log10_prep, nPcs = 5, method="rnipals")
norm_values_log10_prep_rnipals <- pca(norm_values_log10_prep, nPcs = 5, method="rnipals")

write.table(norm_values_log10_prep_rnipals@completeObs,
            "output/norm_values_log10_rnipals_completeObs.txt", sep="\t")

#palette(rainbow(36))
#pairs(gmd_values_log10_prep_rnipals@scores, col = gmd_meta_model_sort$genotype_class)
#pairs(norm_values_log10_prep_rnipals@scores, col = gmd_meta_model_sort$genotype_class)
palette(rainbow(12))
pairs(gmd_values_log10_prep_rnipals@scores, col = gmd_meta_model_sort$trial_2)
pairs(norm_values_log10_prep_rnipals@scores, col = gmd_meta_model_sort$trial_2)
```


# Define training and test data
```{r define training/test data}
tolerance_table <- read.table("data/tolerance_phenotyper_metadata_2sub.txt", header=T, sep="\t")

feld_data <- norm_values_log10_prep_rnipals@completeObs[feld_idx,]
head(rownames(feld_data))
head(gmd_meta_model_feld$chromatogram)

gmd_meta_model_feld_joined <- merge(gmd_meta_model_feld, tolerance_table, 
                                    by.x = "genotype_name", by.y = "cultivar")

# 911 samples (of 995) because 3 cultivars were removed!

train_idx <- which(gmd_meta_model_feld_joined$model_set=="train")
test_idx <- which(gmd_meta_model_feld_joined$model_set=="test")

train_data <- feld_data[train_idx, ]
test_data <- feld_data[test_idx, ]
colnames(train_data) = analytes_sel_exp_sort$analyteID
colnames(test_data) = analytes_sel_exp_sort$analyteID

# with short metabolite names
#train_data2 <- all_merge_IIIc_field_exp_compObs[train_idx, ]
#test_data2 <- all_merge_IIIc_field_exp_compObs[test_idx, ]
#colnames(train_data2) = analytes_valdis$name_short
#colnames(test_data2) = analytes_valdis$name_short

train_info <- gmd_meta_model_feld_joined[train_idx,]
test_info <- gmd_meta_model_feld_joined[test_idx,]

## only control
train_data_control <- subset (train_data, train_info$treatment=="control")
test_data_control <- subset (test_data, test_info$treatment=="control")
colnames(train_data_control) = analytes_sel_exp_sort$analyteID
colnames(test_data_control) = analytes_sel_exp_sort$analyteID

train_info_control <- subset (train_info, train_info$treatment=="control")
test_info_control <- subset (test_info, test_info$treatment=="control")
```

# define all data (without 3 cultivars --> model_set=="NA") and subset of all control samples
```{r all data (control)}
all_data <- subset(feld_data, !gmd_meta_model_feld_joined$model_set=="NA")
colnames(all_data) = analytes_sel_exp_sort$analyteID

all_info <- subset (gmd_meta_model_feld_joined, !gmd_meta_model_feld_joined$model_set=="NA")

# all control samples (ohne NA -> 3 Kutlivare)
all_data_control <- subset(feld_data, 
                           gmd_meta_model_feld_joined$treatment=="control" 
                           & !gmd_meta_model_feld_joined$model_set=="NA")

colnames(all_data_control) = analytes_sel_exp_sort$analyteID

all_info_control <- subset (gmd_meta_model_feld_joined, 
                            gmd_meta_model_feld_joined$treatment=="control" 
                            & !gmd_meta_model_feld_joined$model_set=="NA")
```

# define valdis data
```{r define valdis data}
length(valdis_idx)
# 1671

valdis_data <- norm_values_log10_prep_rnipals@completeObs[valdis_idx,]
colnames(valdis_data) = analytes_sel_exp_sort$analyteID

gmd_meta_model_valdis <- droplevels(gmd_meta_model_sort[valdis_idx,])
dim(gmd_meta_model_valdis)
```


### random forest classification: train data with 3 classes
```{r rf cat3 train}
input_cat3_train <- data.frame(train_data, "tol" = train_info$tol_cat3_fve)
levels(input_cat3_train$tol)

set.seed(1234)
rf_cat3_train <- randomForest(tol~. , data=input_cat3_train, ntree=1000)
print(rf_cat3_train)
confusionMatrix(predict(rf_cat3_train, train_data), train_info$tol_cat3_fve)

head(importance(rf_cat3_train))
tail(sort(importance(rf_cat3_train)))
varImpPlot(rf_cat3_train, main="")



table(predict(rf_cat3_train, test_data), test_info$tol_cat3_fve)
confusionMatrix(predict(rf_cat3_train, test_data), test_info$tol_cat3_fve)
#table(test_info$tol_cat3_fve)

# decision tree:
confusionMatrix(table(predict(tree_cat3_train, test_data, type="class"), test_info$tol_cat3_fve))
confusionMatrix(table(predict(tree_cat3_train_pruned, test_data, type="class"), test_info$tol_cat3_fve))

#######################################
# USED FOR FINAL TROST PROJECT REPORT #
#######################################

# 
# ###############################
# # with real metabolite names
# input_cat3_train2 <- as.data.frame( cbind(train_data2, "tol"=train_info$tol_cat3_fve))
# input_cat3_train2$tol <- train_info$tol_cat3_fve
# levels(input_cat3_train2$tol)
# 
# set.seed(1234)
# rf_cat3_train2 <- randomForest(tol~. , data=input_cat3_train2, ntree=1000)
# print(rf_cat3_train)
# 
# tail(sort(importance(rf_cat3_train)))
# varImpPlot(rf_cat3_train, main="")
```


# Save workspace
```{r save workspace}
save.image(paste("prediction_model_trost_valdis_", Sys.Date(), ".RData", sep="") )
```


# SessionInfo
```{r sessionInfo}
 sessionInfo()
```