TROST Phenotyper Metadata for GCMS Aliquots
========================================================

Date: 15.01.2014  
Author: Heike Sprenger  
Comment: Das Paket RMySQL konnte nicht installiert werden. Daher das Paket RODBC verwenden, um die Phenotyper DB mit R zu verbinden.   
Dazu vorher das Programm MySQL Connector ODBC installieren und konfigurieren.   
http://passionfordata.blogspot.de/2012/04/how-to-integrate-r-with-mysql-database.html  
http://dev.mysql.com/doc/refman/5.0/en/connector-odbc-configuration-dsn-windows.html#connector-odbc-configuration-dsn-windows-5-1  

**Update: RMySQL statt RODBC verwenden!**

### set working directory
```{r set working directory}
# setwd("D:/work/repos/trost_metabolomics")
# setwd("~/work/repos/trost_metabolomics")
```

[solution for issue with working directory and knitr](https://github.com/yihui/knitr/issues/277)

### Load workspace, packages and scripts
```{r load workspace, message=FALSE}
# load packages
library(knitr)
library(ggplot2)
library(reshape)
library(reshape2)
library(pander)
library(plyr)
# library(RODBC)
library(RMySQL)
library(yaml)

# set options for pander
panderOptions('table.split.table', 200)

# set options for knitr
opts_chunk$set(fig.width=5, fig.height=5, cache=FALSE, highlight = TRUE, fig.show="asis")
opts_knit$set(root.dir = '../')

# options(width=600)

# load workspace
# load("phenotyper.RData")
```


### source R functions
```{r source R functions, include=FALSE}
source("../libpurzel/func_get_phenotyper_data.R")
```


### Set up database connection
```{r set up database connection}
# dbhandle <- odbcDriverConnect('driver={SQL Server}; 
#                               server=r710sqljahu; 
#                               database=GMD; 
#                               trusted_connection=true')

login <- yaml.load_file("../libpurzel/login.yaml")

phenotyper <- dbConnect(MySQL(), user=login$user, password=login$passwd, dbname=login$db, host=login$host)  
```


### OLD
Execute Master Query from ``~\work\repos\database_scripts\master_query.sql`` to get information about FW and calculated DW of aliquots

### NEW
Execute Master Query from ``~\work\repos\database_scripts\masterquery-2014-03-12.sql`` to get information about FW and calculated DW of aliquots

```{r master query}
master_query_result_2014_03_12 <- func_use_master_query()
pander(head(master_query_result_2014_03_12))
write.table(master_query_result_2014_03_12, "data/master_query_result_2014_03_12.txt", sep="\t")
```

### OLD
Execute Meta Query from ``~\work\repos\database_scripts\metaquery-2013-12-18.sql`` to get information about cultivar, treatment, sample_time, culture of aliquots etc.  

BEFORE: FIRST execute the lines 1 to 10547 in the metaquery by MySQL Workbench to create temporary tables!  
AFTER executing the SELECT query in R execute the last two lines of the metaquery by MySQL Workbench to delete temporary tables!  

### OLD
Execute Meta Query from ``~\work\repos\database_scripts\metaquery-2014-01-28.sql`` to get information about cultivar, treatment, sample_time, culture of aliquots etc.  

No other executions necessary anymore because tables are already existing (not temporary)!

### NEW
Execute Meta Query from ``~\work\repos\database_scripts\metaquery-2014-06-24.sql`` to get information about cultivar, treatment, sample_time, culture of aliquots etc.  


```{r meta query}
meta_query_result_2014_06_24 <- func_use_meta_query()
pander(head(meta_query_result_2014_06_24))
write.table(meta_query_result_2014_06_24, "data/meta_query_result_2014_06_24.txt", sep="\t")
```


### dimensions of both result tables and missing IDs in master_query_result
```{r dimensions of both result tables}
dim(master_query_result_2014_03_12)
# 3745 12
dim(meta_query_result_2014_06_24)
# 3747 13
setdiff(meta_query_result_2014_06_24$GMD_id, master_query_result_2014_03_12$GMD_id)
# "12073ia_11" "13129if_38"
```

**"12073ia_11" "13129if_38"**

- GMD IDs belong to AliquotIDs **1053917   1264318**
``select * from aliquot_query where aliquot_query.gmd_id in (12073ia_11", "13129if_38");``
- these GMD IDs or Aliquots are missing in master_query_result_2014_03_12

**explanation**  
- tara weight of aliquot **1053917** (SampleID: 862968, MPI field 2011/1) missing, file: "trost_2011_05_24_7.txt"  
- FW und DW of aliquot **1264318** (SampleID: 881811, MPI field 2012) missing, file: "trost_2012_06_19_5.txt", "trost_2012_06_21_1.txt" 


### join both result tables
```{r join both result tables}
# join by gmd_id
phenotyper_result_joined <- join(meta_query_result_2014_06_24, master_query_result_2014_03_12, by = "GMD_id" )
dim(phenotyper_result_joined)
# 3747 24

phenotyper_valdis <- read.table("data/phenotyper_valdis.txt", sep="\t", header=T, check.names = F)
dim(phenotyper_valdis)
# 808 24

phenotyper_result_joined_valdis <- rbind(phenotyper_result_joined, phenotyper_valdis)
dim(phenotyper_result_joined_valdis)
# 4555 24

write.table(phenotyper_result_joined, "data/phenotyper_result_joined.txt", sep="\t")
write.table(phenotyper_result_joined_valdis, "data/phenotyper_result_joined_valdis.txt", sep="\t")

# join by aliquot_id
# phenotyper_result_joined_by_aliquot <- join(meta_query_result_2014_06_24, master_query_result_2014_03_12, by = "aliquot_id" )
# write.table(phenotyper_result_joined_by_aliquot, "../data/phenotyper_result_joined_by_aliquot.txt", sep="\t")
```


### save workspace
```{r save workspace}
save.image("phenotyper.RData")
```

